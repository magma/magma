<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><title>lte/sessiond · Magma Documentation</title><meta name="viewport" content="width=device-width"/><meta name="generator" content="Docusaurus"/><meta name="description" content="# Session Management in Magma"/><meta name="docsearch:version" content="next"/><meta name="docsearch:language" content="en"/><meta property="og:title" content="lte/sessiond · Magma Documentation"/><meta property="og:type" content="website"/><meta property="og:url" content="https://magma.github.io/magma/"/><meta property="og:description" content="# Session Management in Magma"/><meta property="og:image" content="https://magma.github.io/magma/img/docusaurus.png"/><meta name="twitter:card" content="summary"/><meta name="twitter:image" content="https://magma.github.io/magma/img/docusaurus.png"/><link rel="shortcut icon" href="/magma/img/icon.png"/><link rel="stylesheet" href="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.css"/><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css"/><script type="text/javascript" src="https://buttons.github.io/buttons.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script><script type="text/javascript" src="/init.js"></script><script src="/magma/js/scrollSpy.js"></script><link rel="stylesheet" href="/magma/css/main.css"/><script src="/magma/js/codetabs.js"></script></head><body class="sideNavVisible separateOnPageNav"><div class="fixedHeaderContainer"><div class="headerWrapper wrapper"><header><a href="/magma/"><img class="logo" src="/magma/img/magma-logo.svg" alt="Magma Documentation"/><h2 class="headerTitleWithLogo">Magma Documentation</h2></a><a href="/magma/versions"><h3>next</h3></a><div class="navigationWrapper navigationSlider"><nav class="slidingNav"><ul class="nav-site nav-site-internal"><li class=""><a href="https://magmacore.org" target="_self">Home</a></li><li class=""><a target="_self"> | </a></li><li class=""><a href="/magma/" target="_self">Docs</a></li><li class=""><a target="_self"> | </a></li><li class=""><a href="https://github.com/magma" target="_self">Code</a></li><li class=""><a target="_self"> | </a></li><li class=""><a href="https://magmacore.org/community" target="_self">Community</a></li><li class="navSearchWrapper reactNavSearchWrapper"><input type="text" id="search_input_react" placeholder="Search" title="Search"/></li></ul></nav></div></header></div></div><div class="navPusher"><div class="docMainWrapper wrapper"><div class="container mainContainer docsContainer"><div class="wrapper"><div class="post"><header class="postHeader"><h1 id="__docusaurus" class="postHeaderTitle">lte/sessiond</h1></header><article><div><span><h1><a class="anchor" aria-hidden="true" id="session-management-in-magma"></a><a href="#session-management-in-magma" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Session Management in Magma</h1>
<h2><a class="anchor" aria-hidden="true" id="overview-of-sessiond"></a><a href="#overview-of-sessiond" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Overview of SessionD</h2>
<p>SessionD is the main service responsible for managing and enforcing session
configurations.</p>
<h3><a class="anchor" aria-hidden="true" id="interfaces"></a><a href="#interfaces" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Interfaces</h3>
<p>SessionD interfaces with three distinct external components.</p>
<ol>
<li><p>Access (MME, AAA)</p>
<p>This component receives all connection and session related information from the UE. It also handles mobility management. But from SessionD's point of view, it notifies SessionD whenever a UE is attached or detached. This notification will include any context that SessionD needs for enforcement.</p></li>
<li><p>Policy (PolicyDB, FeG+PCRF/OCS)</p>
<p>This component is responsible for propagating any session or policy configuration that SessionD must enforce. Whenever a new UE is introduced, SessionD will reach out to this component to fetch any configuration. Depending on the configuration, SessionD maybe reach out to this component for updates.</p></li>
<li><p>User Plane (PipelineD)</p>
<p>This component is responsible for policy and QoS enforcement. It receives
any relevant policy and QoS configuration from SessionD and periodically
reports usage accordingly.</p></li>
</ol>
<h3><a class="anchor" aria-hidden="true" id="internal-architecture"></a><a href="#internal-architecture" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Internal Architecture</h3>
<p><img src="SessionD_Architecture.png" alt="Internal Architecture Diagram"></p>
<h2><a class="anchor" aria-hidden="true" id="configurations-not-exhaustive"></a><a href="#configurations-not-exhaustive" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Configurations (Not Exhaustive)</h2>
<ul>
<li><p>FeG Relay</p>
<p>A federation gateway, FeG, is an entity responsible for hosting a centralized
control plane interface towards an operator core. In terms of session
management, the SessionProxy service on a FeG will relay all session related
interactions.</p>
<p>This feature can be enabled on the Orc8r with a network wide
<code>gx_gy_relay_enabled</code> flag. When it is disabled, a local PolicyDB service
is used in place. This service will directly fetch session configurations
from the Orc8r.</p>
<p>The feature is disabled by default.</p></li>
<li><p>Omnipresent Rules</p>
<p><em>This feature is currently only relevant for the federated case.</em></p>
<p>Omnipresent rules are policies that are applied to all subscribers in a network. The list of such policies are configured on the Orc8r as a network configuration and are streamed down to all gateways in the network. These policies are added onto the list of policies configured by the PCRF.</p></li>
<li><p>Zero Wallet Detections</p>
<p><em>This feature is currently only relevant for the CWF case.</em></p>
<p>This configures a way for SessionD to detect when a subscriber is out of valid wallet. When an empty wallet is detected, the empty status is propagated to PipelineD, which hosts a flask server that indicates the state. After a configured number of seconds, the session will be terminated and the user will be kicked out. The configuration is done in Orc8r, but it is not currently exposed by an API. This timeout is configured in <code>sessiond.yml</code> with <code>cwf_quota_exhaustion_termination_on_init_ms</code>.</p>
<p>The detection methods are described below:</p>
<ul>
<li>GxTrackedRules: Wallet is empty if there are no active PCRF tracked policy.</li>
<li>PCRF tracked policies are policies with tracking type <code>PCRF_ONLY</code> or
<code>PCRF_AND_OCS</code>.</li>
</ul></li>
<li><p><code>magma/lte/gateway/configs/sessiond.yml</code> has more configurations that are managed on each gateway.</p></li>
</ul>
<h2><a class="anchor" aria-hidden="true" id="stateless-operation"></a><a href="#stateless-operation" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Stateless Operation</h2>
<p>A stateless SessionD service can be enabled by the <code>support_stateless</code> flag in
<code>sessiond.yml</code>. This feature allows SessionD to be restarted without requiring
previously existing sessions to be re-authenticated.</p>
<p>With this feature, SessionD stores all session state updates into Redis for
persistent storage. When a session states needs to be modified, the state is
loaded from storage and modified in memory. When the modification is complete,
the updates are written back into Redis. When the feature is disabled, all
states are kept in memory.</p>
<p><code>SessionStore</code> is the interface to storage that makes the decision of where the
states are kept based on the <code>support_stateless</code> flag.
Updates to stored session state are done with the <code>UpdateCriteria</code> structures
passed into <code>SessionStore</code>.</p>
<p>To ensure that SessionD can always be restarted properly, session state
should always be consistent with services with which it interacts.
On SessionD restart, session state will be synced to MME service, which
it will use as the source of truth for active sessions.
Based on the active sessions, PipelineD will be instructed to
allow/disallow traffic.</p>
<h2><a class="anchor" aria-hidden="true" id="enforcement-algorithm"></a><a href="#enforcement-algorithm" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Enforcement algorithm</h2>
<p>Sessiond can report credit to PCRF (Gx) and OCS (Gy). In both cases it is up to
PCRF or OCS to determine when the user is out of quota. Sessiond will only receive,
count, report and execute actions from the core. The algorithms here described
are mainly related how to interpret the orders received by PCRF and OCS and how
in advance we will report to the core to prevent to hit the exhaustion prematurely.
Sessiond will not execute any action unless receiving an explicit order from
PCRF and OCS.</p>
<p>Gx reporting will be identified with monitoring key, while Gy reporting will be
identified by charging key.</p>
<p>Both Gx and Gy reporting have some commonalities on its algorithm:</p>
<ol>
<li>PCRF/OCS will send an initial grant with allowed credit to be reported.</li>
<li>Sessiond will count the credits used but it will not report back anything yet</li>
<li>When a specific percentage of that grant is reached, Sessiond will send a
report to OCS or PCRF with used units (by default 80% and can be changed at
<code>sessiond.yml</code> using parameter <code>sessiond_readme_quota_exhaustion</code>). In case of
overusage, this will be reported too. So it is up to PCRF/OCS to take that
overusage into consideration</li>
<li>PCRF/OCS will then send back another grant, which will be added to the still
remaining grant.</li>
<li>PCRF/OCS can also include an indication to let SessionD know that there is
no more quota available for that user. So SessionD will only have a small
percentage left (around 20%) until is exhausted and execute an specific
action</li>
</ol>
<p>See that PCRF or OCS can request to track the credit using Tx only, Rx only, Tx and Rx,
TX, RX and Total. The tracking type will be determined by the very first grant received
and will remain the same for the entire session for that specific monitor key (Gx reporting)
or charging key (Gy reporting)</p>
<p>To better understand the exhaustion algorithm refer to <code>SessionCredit::is_quota_exhausted</code></p>
<p>Below you have some differences on how SessionD deals with GX and Gy reporting</p>
<h3><a class="anchor" aria-hidden="true" id="pcrf-gx-reporting"></a><a href="#pcrf-gx-reporting" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>PCRF (Gx reporting)</h3>
<p>Gx reporting will not cause a session termination. Gx reporting will report credit
back to PCRF until quota is exhausted. Once quota is exhausted, the monitor will be
deleted from SessionD (stop reporting) but the session or the policy related with
that monitoring key will not be removed.</p>
<p>Monitor removal will be triggered by PCRF sending a grant with one of its components
(tx, rx or total) set to 0 (or not set). Note that this component (tx, rx or total)
must be one of the tracked types. So if we are tracking TX and RX, the deletion of
the monitor will be triggered if we receive either a 0 on Tx or Rx
(total component will be ignored).</p>
<p>When SessionD receives a 0 on one of its tracked components of the last received
grant, the monitor will not be deleted immediately. Sessiond will exhaust the remaining
credit still left (remember we still have around 20% left of the previous grant), and
then stop reporting removing the monitoring key.</p>
<h3><a class="anchor" aria-hidden="true" id="ocs-gy-reporting"></a><a href="#ocs-gy-reporting" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>OCS (Gy reporting)</h3>
<p>Gy reporting will cause session termination, redirection or restriction. Gy reporting will
report credit back to OCS until quota is exhausted. Then, and depending on
Final Unit Action, the session may be terminated, redirected or restricted.
In all cases, this will have impact on the whole session, not on a specific policy of
that session</p>
<p>Session action will be triggered by OCS sending a grant which must include AVP
Final Action Indication. If this AVP is not included, SessionD will keep tracking
and reporting to OCS, even if quota is exhausted, but it will not take any action.
The reason for that is that we don't want to trigger an early termination of the
session due to OCS being too slow to provide a grant. Also, Per 3gpp
Final Unit Indication AVP is needed to trigger any action by SessionD.</p>
<p>Note when SessionD receives a grant which includes Final Unit Indicaton, it
will continue tracking this charging key until any of its quotas is exhausted.
Once it is exhausted, Final Unit Action (termnate, redirect, restrict)
will be executed.</p>
<h4><a class="anchor" aria-hidden="true" id="enabling-restriction"></a><a href="#enabling-restriction" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Enabling Restriction</h4>
<p>In addition to Final Unit Action AVP, OCS must include a list of Filter-ID AVP in the
final grant. These filters reference static policy rule identifiers that are pre-provisioned
in PCRF and should contain an explicit DENY rule for non allowed traffic.</p>
<p>Note that static rules referenced in Filter-ID must not be activated by Gx Interface due to a
limitation in pipelined.</p>
<h4><a class="anchor" aria-hidden="true" id="enabling-redirection"></a><a href="#enabling-redirection" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Enabling Redirection</h4>
<p>In addition to Final Unit Action AVP, OCS must include a Redirect-Information AVP which
includes the redirect server address and the address type (URL/IPV4) in the final grant.</p>
<p>Note that SIP_URI and IPV6 are not supported.</p>
</span></div></article></div><div class="docs-prevnext"></div></div></div><nav class="onPageNav"><ul class="toc-headings"><li><a href="#overview-of-sessiond">Overview of SessionD</a><ul class="toc-headings"><li><a href="#interfaces">Interfaces</a></li><li><a href="#internal-architecture">Internal Architecture</a></li></ul></li><li><a href="#configurations-not-exhaustive">Configurations (Not Exhaustive)</a></li><li><a href="#stateless-operation">Stateless Operation</a></li><li><a href="#enforcement-algorithm">Enforcement algorithm</a><ul class="toc-headings"><li><a href="#pcrf-gx-reporting">PCRF (Gx reporting)</a></li><li><a href="#ocs-gy-reporting">OCS (Gy reporting)</a></li></ul></li></ul></nav></div><footer class="nav-footer" id="footer"><section class="sitemap"><a href="/magma/" class="nav-home"><img src="/magma/img/magma_icon.png" alt="Magma Documentation" width="66"/></a><div><h5>Docs</h5><a href="https://github.com/facebookincubator/magma/blob/master/docs/Magma_Product_Overview.pdf">Magma Product Overview</a><a href="https://github.com/facebookincubator/magma/blob/master/docs/Magma_Specs_V1.1.pdf">Magma Spec</a></div><div><h5>Community</h5><a href="https://discord.gg/4YxZbft">Discord</a><a href="https://fb.me/magmadevsummit" target="_blank" rel="noreferrer noopener">Magma Dev Summit</a></div><div><h5>More</h5><a href="https://code.fb.com/open-source/magma/">Blog</a><a href="https://github.com/facebookincubator/magma">GitHub</a></div></section><section class="copyright">Copyright © 2021 The Magma Authors</section></footer></div><script type="text/javascript" src="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.js"></script><script>
                document.addEventListener('keyup', function(e) {
                  if (e.target !== document.body) {
                    return;
                  }
                  // keyCode for '/' (slash)
                  if (e.keyCode === 191) {
                    const search = document.getElementById('search_input_react');
                    search && search.focus();
                  }
                });
              </script><script>
              var search = docsearch({
                
                apiKey: 'f95caeb7bc059b294eec88e340e5445b',
                indexName: 'magma',
                inputSelector: '#search_input_react'
              });
            </script></body></html>