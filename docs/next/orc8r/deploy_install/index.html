<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><title>Installing Orchestrator · Magma</title><meta name="viewport" content="width=device-width"/><meta name="generator" content="Docusaurus"/><meta name="description" content="# Installing Orchestrator"/><meta name="docsearch:version" content="next"/><meta name="docsearch:language" content="en"/><meta property="og:title" content="Installing Orchestrator · Magma"/><meta property="og:type" content="website"/><meta property="og:url" content="https://facebookincubator.github.io/magma/"/><meta property="og:description" content="# Installing Orchestrator"/><meta property="og:image" content="https://facebookincubator.github.io/magma/img/docusaurus.png"/><meta name="twitter:card" content="summary"/><meta name="twitter:image" content="https://facebookincubator.github.io/magma/img/docusaurus.png"/><link rel="shortcut icon" href="/magma/img/favicon.png"/><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css"/><script type="text/javascript" src="https://buttons.github.io/buttons.js"></script><script src="/magma/js/scrollSpy.js"></script><link rel="stylesheet" href="/magma/css/main.css"/><script src="/magma/js/codetabs.js"></script></head><body class="sideNavVisible separateOnPageNav"><div class="fixedHeaderContainer"><div class="headerWrapper wrapper"><header><a href="/magma/"><img class="logo" src="/magma/img/fb.png" alt="Magma"/><h2 class="headerTitleWithLogo">Magma</h2></a><a href="/magma/versions"><h3>next</h3></a><div class="navigationWrapper navigationSlider"><nav class="slidingNav"><ul class="nav-site nav-site-internal"><li class="siteNavGroupActive"><a href="/magma/docs/next/basics/introduction" target="_self">Docs</a></li><li class=""><a href="/magma/help" target="_self">Help</a></li><li class=""><a href="https://github.com/facebookincubator/magma" target="_self">Github</a></li></ul></nav></div></header></div></div><div class="navPusher"><div class="docMainWrapper wrapper"><div class="docsNavContainer" id="docsNav"><nav class="toc"><div class="toggleNav"><section class="navWrapper wrapper"><div class="navBreadcrumb wrapper"><div class="navToggle" id="navToggler"><div class="hamburger-menu"><div class="line1"></div><div class="line2"></div><div class="line3"></div></div></div><h2><i>›</i><span>Deploying Orchestrator</span></h2><div class="tocToggler" id="tocToggler"><i class="icon-toc"></i></div></div><div class="navGroups"><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">Basics<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><li class="navListItem"><a class="navItem" href="/magma/docs/next/basics/introduction">Introduction</a></li><li class="navListItem"><a class="navItem" href="/magma/docs/next/basics/prerequisites">Prerequisites</a></li><li class="navListItem"><a class="navItem" href="/magma/docs/next/basics/quick_start_guide">Quick Start Guide</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">Orchestrator<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><div class="navGroup subNavGroup"><h4 class="navGroupSubcategoryTitle">Deploying Orchestrator</h4><ul><li class="navListItem"><a class="navItem" href="/magma/docs/next/orc8r/deploy_intro">Introduction</a></li><li class="navListItem"><a class="navItem" href="/magma/docs/next/orc8r/deploy_build">Building Orchestrator</a></li><li class="navListItem"><a class="navItem" href="/magma/docs/next/orc8r/deploy_terraform">Terraforming Orchestrator on AWS</a></li><li class="navListItem navListItemActive"><a class="navItem" href="/magma/docs/next/orc8r/deploy_install">Installing Orchestrator</a></li><li class="navListItem"><a class="navItem" href="/magma/docs/next/orc8r/deploy_dns">DNS Resolution</a></li></ul></div></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">Access Gateway<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><li class="navListItem"><a class="navItem" href="/magma/docs/next/lte/setup_deb">Setup (Bare Metal)</a></li><li class="navListItem"><a class="navItem" href="/magma/docs/next/lte/config_agw">AGW Configuration</a></li><li class="navListItem"><a class="navItem" href="/magma/docs/next/lte/enodebd">eNodeB Configuration</a></li><li class="navListItem"><a class="navItem" href="/magma/docs/next/lte/tr069">Adding TR-069 support for an eNodeB</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">Federation Gateway<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><div class="navGroup subNavGroup"><h4 class="navGroupSubcategoryTitle">Deploying FeG</h4><ul><li class="navListItem"><a class="navItem" href="/magma/docs/next/feg/deploy_intro">Introduction</a></li><li class="navListItem"><a class="navItem" href="/magma/docs/next/feg/deploy_build">Building Federation Gateway</a></li><li class="navListItem"><a class="navItem" href="/magma/docs/next/feg/deploy_install">Installing Federation Gateway</a></li></ul></div></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">Symphony<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><li class="navListItem"><a class="navItem" href="/magma/docs/next/symphony/quick_start">Symphony Agent Quick Start</a></li><li class="navListItem"><a class="navItem" href="/magma/docs/next/symphony/building_the_symphony_agent">Building the Symphony Agent</a></li></ul></div></div></section></div><script>
            var coll = document.getElementsByClassName('collapsible');
            var checkActiveCategory = true;
            for (var i = 0; i < coll.length; i++) {
              var links = coll[i].nextElementSibling.getElementsByTagName('*');
              if (checkActiveCategory){
                for (var j = 0; j < links.length; j++) {
                  if (links[j].classList.contains('navListItemActive')){
                    coll[i].nextElementSibling.classList.toggle('hide');
                    coll[i].childNodes[1].classList.toggle('rotate');
                    checkActiveCategory = false;
                    break;
                  }
                }
              }

              coll[i].addEventListener('click', function() {
                var arrow = this.childNodes[1];
                arrow.classList.toggle('rotate');
                var content = this.nextElementSibling;
                content.classList.toggle('hide');
              });
            }

            document.addEventListener('DOMContentLoaded', function() {
              createToggler('#navToggler', '#docsNav', 'docsSliderActive');
              createToggler('#tocToggler', 'body', 'tocActive');

              var headings = document.querySelector('.toc-headings');
              headings && headings.addEventListener('click', function(event) {
                var el = event.target;
                while(el !== headings){
                  if (el.tagName === 'A') {
                    document.body.classList.remove('tocActive');
                    break;
                  } else{
                    el = el.parentNode;
                  }
                }
              }, false);

              function createToggler(togglerSelector, targetSelector, className) {
                var toggler = document.querySelector(togglerSelector);
                var target = document.querySelector(targetSelector);

                if (!toggler) {
                  return;
                }

                toggler.onclick = function(event) {
                  event.preventDefault();

                  target.classList.toggle(className);
                };
              }
            });
        </script></nav></div><div class="container mainContainer docsContainer"><div class="wrapper"><div class="post"><header class="postHeader"></header><article><div><span><h1><a class="anchor" aria-hidden="true" id="installing-orchestrator"></a><a href="#installing-orchestrator" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Installing Orchestrator</h1>
<h2><a class="anchor" aria-hidden="true" id="creating-secrets"></a><a href="#creating-secrets" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Creating Secrets</h2>
<p>IMPORTANT: in all the below instructions, replace <code>yourdomain.com</code> with the
actual domain/subdomain which you've chosen to host Orchestrator on.</p>
<p>We recommend storing the following secrets on S3 in AWS, or any similar
object storage service on your preferred cloud provider.</p>
<p>Start first by creating a new directory somewhere to hold the secrets while
you create them:</p>
<pre><code class="hljs css language-bash">mkdir -p ~/secrets/
</code></pre>
<h3><a class="anchor" aria-hidden="true" id="ssl-certificates"></a><a href="#ssl-certificates" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>SSL Certificates</h3>
<p>You will need the following certificates and private keys:</p>
<ol>
<li>The public SSL certificate for your Orchestrator domain,
with CN=*.yourdomain.com. This can be an SSL certificate chain, but it must be
in one file</li>
<li>The private key which corresponds to the above SSL certificate</li>
<li>The rootCA certificate which verifies your SSL certificate.</li>
</ol>
<p>If you already have these files, you can do the following:</p>
<ol>
<li>Rename your public SSL certificate to <code>controller.crt</code></li>
<li>Rename your SSL certificate's private key to <code>controller.key</code></li>
<li>Rename your SSL certificate's root CA to <code>rootCA.pem</code></li>
<li>Put these 3 files under a subdirectory <code>certs</code></li>
</ol>
<p>If you aren't worried about a browser warning, you can also self-sign these
certs. Change the values of the DN prompts as necessary, but pay <em>very</em> close
attention to the common names - these are very important to get right!</p>
<pre><code class="hljs css language-bash">$ mkdir -p ~/secrets/certs
$ <span class="hljs-built_in">cd</span> ~/secrets/certs
$ openssl genrsa -out rootCA.key 2048

Generating RSA private key, 2048 bit long modulus

$ openssl req -x509 -new -nodes -key rootCA.key -sha256 -days 3650 -out rootCA.pem

You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter <span class="hljs-string">'.'</span>, the field will be left blank.
-----
Country Name (2 letter code) []:US
State or Province Name (full name) []:CA
Locality Name (eg, city) []:Menlo Park
Organization Name (eg, company) []:Facebook
Organizational Unit Name (eg, section) []:Magma
Common Name (eg, fully qualified host name) []:rootca.yourdomain.com
Email Address []:admin@yourdomain.com

$ openssl genrsa -out controller.key 2048

Generating RSA private key, 2048 bit long modulus

$ openssl req -new -key controller.key -out controller.csr

You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter <span class="hljs-string">'.'</span>, the field will be left blank.
-----
Country Name (2 letter code) []:US
State or Province Name (full name) []:CA
Locality Name (eg, city) []:Menlo Park
Organization Name (eg, company) []:Facebook
Organizational Unit Name (eg, section) []:Magma
Common Name (eg, fully qualified host name) []:*.yourdomain.com
Email Address []:admin@yourdomain.com

Please enter the following <span class="hljs-string">'extra'</span> attributes
to be sent with your certificate request
A challenge password []:

$ openssl x509 -req -<span class="hljs-keyword">in</span> controller.csr -CA rootCA.pem -CAkey rootCA.key -CAcreateserial -out controller.crt -days 365 -sha256

Signature ok
subject=/C=US/ST=CA/L=Menlo Park/O=Facebook/OU=Magma/CN=*.yourdomain.com/emailAddress=admin@yourdomain.com
Getting CA Private Key

$ rm controller.csr rootCA.key rootCA.srl
</code></pre>
<p>At this point, regardless of whether you self-signed your certs or acquired
them from a certificate provider, your <code>certs</code> subdirectory should look like
this:</p>
<pre><code class="hljs css language-bash">$ ls
controller.crt  controller.key  rootCA.pem
</code></pre>
<h3><a class="anchor" aria-hidden="true" id="application-certificates-and-keys"></a><a href="#application-certificates-and-keys" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Application Certificates and Keys</h3>
<p><code>certifier</code> is the Orchestrator service which signs client certificates. All
access to Orchestrator is authenticated by client SSL certificates, so you'll
need to create the verifying certificate for <code>certifier</code>.</p>
<p>Again, pay <em>very</em> close attention to the CN.</p>
<pre><code class="hljs css language-bash">$ openssl genrsa -out certifier.key 2048

Generating RSA private key, 2048 bit long modulus

$ openssl req -x509 -new -nodes -key certifier.key -sha256 -days 3650 -out certifier.pem

...
Common Name (eg, fully qualified host name) []:certifier.yourdomain.com

$ openssl genrsa -out bootstrapper.key 2048

Generating RSA private key, 2048 bit long modulus

$ ls
bootstrapper.key  certifier.key     certifier.pem     controller.crt    controller.key    rootCA.pem
</code></pre>
<p>The last command created a private key for the <code>bootstrapper</code> service, which
is the mechanism by which Access Gateways acquire their client certificates
from <code>certifier</code>.</p>
<h3><a class="anchor" aria-hidden="true" id="environment-secrets"></a><a href="#environment-secrets" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Environment Secrets</h3>
<p>Go into the AWS management console, choose &quot;RDS&quot;, and find the hostname of your
orc8r RDS instance (make sure not to choose the NMS RDS instance). Note this
down, then continue:</p>
<pre><code class="hljs css language-bash">mkdir -p ~/secrets/envdir
<span class="hljs-built_in">cd</span> ~/secrets/envdir
<span class="hljs-built_in">echo</span> <span class="hljs-string">"STREAMER,SUBSCRIBERDB,METRICSD,CERTIFIER,BOOTSTRAPPER,METERINGD_RECORDS,ACCESSD,OBSIDIAN,DISPATCHER,DIRECTORYD"</span> &gt; CONTROLLER_SERVICES
<span class="hljs-built_in">echo</span> <span class="hljs-string">"dbname=orc8r user=orc8r password=&lt;YOUR ORC8R DB PASSWORD&gt; host=&lt;YOUR ORC8R RDS ENDPOINT&gt;"</span> &gt; DATABASE_SOURCE
</code></pre>
<h3><a class="anchor" aria-hidden="true" id="static-configuration-files"></a><a href="#static-configuration-files" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Static Configuration Files</h3>
<p>Orchestrator microservices can be configured with static YAML files. In this
deployment, the only one you'll have to create will be for <code>metricsd</code>:</p>
<pre><code class="hljs css language-bash">mkdir -p ~/secrets/configs/orc8r
<span class="hljs-built_in">cd</span> ~/secrets/configs/orc8r
touch metricsd.yml
</code></pre>
<p>Put the following contents into <code>metricsd.yml</code>:</p>
<pre><code class="hljs"><span class="hljs-symbol">profile:</span> <span class="hljs-string">"prometheus"</span>

<span class="hljs-symbol">prometheusQueryAddress:</span> <span class="hljs-string">"http://orc8r-prometheus:9090"</span>
<span class="hljs-symbol">prometheusPushAddresses:</span>
  - <span class="hljs-string">"http://orc8r-prometheus-cache:9091/metrics"</span>

<span class="hljs-symbol">alertmanagerApiURL:</span> <span class="hljs-string">"http://orc8r-alertmanager:9093/api/v2/alerts"</span>
<span class="hljs-symbol">prometheusConfigServiceURL:</span> <span class="hljs-string">"http://orc8r-config-manager:9100"</span>
<span class="hljs-symbol">alertmanagerConfigServiceURL:</span> <span class="hljs-string">"http://orc8r-config-manager:9101"</span>
</code></pre>
<h2><a class="anchor" aria-hidden="true" id="initial-helm-deploy"></a><a href="#initial-helm-deploy" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Initial Helm Deploy</h2>
<p>Copy your secrets into the Helm subchart where you cloned Magma:</p>
<pre><code class="hljs css language-bash">cp -r ~/secrets magma/orc8r/cloud/helm/orc8r/charts/secrets/.secrets
</code></pre>
<p>We need to set up the EKS cluster before we can <code>helm deploy</code> to it:</p>
<pre><code class="hljs css language-bash"><span class="hljs-built_in">cd</span> magma/orc8r/cloud/helm/orc8r
kubectl apply -f tiller-rbac-config.yaml
helm init --service-account tiller --<span class="hljs-built_in">history</span>-max 200
<span class="hljs-comment"># Wait for tiller to become 'Running'</span>
kubectl get pods -n kube-system | grep tiller

kubectl create namespace magma
</code></pre>
<p>Next, create a <code>vals.yml</code> somewhere in a source controlled directory that you
own (e.g. adjacent to your terraform scripts). Fill in the values in caps
with the correct values for your docker registry and Orchestrator hostname:</p>
<pre><code class="hljs"><span class="hljs-attr">imagePullSecrets:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">orc8r-secrets-registry</span>

<span class="hljs-attr">secrets:</span>
  <span class="hljs-attr">create:</span> <span class="hljs-literal">true</span>
  <span class="hljs-attr">docker:</span>
    <span class="hljs-attr">registry:</span> <span class="hljs-string">YOUR-DOCKER-REGISTRY</span>
    <span class="hljs-attr">username:</span> <span class="hljs-string">YOUR-DOCKER-USERNAME</span>
    <span class="hljs-attr">password:</span> <span class="hljs-string">YOUR-DOCKER-PASSWORD</span>
  

<span class="hljs-attr">proxy:</span>
  <span class="hljs-attr">image:</span>
    <span class="hljs-attr">repository:</span> <span class="hljs-string">YOUR-DOCKER-REGISTRY/proxy</span>
    <span class="hljs-attr">tag:</span> <span class="hljs-string">YOUR-CONTAINER-TAG</span>

  <span class="hljs-attr">replicas:</span> <span class="hljs-number">2</span>

  <span class="hljs-attr">service:</span>
    <span class="hljs-attr">name:</span> <span class="hljs-string">orc8r-bootstrap-legacy</span>
    <span class="hljs-attr">type:</span> <span class="hljs-string">LoadBalancer</span>

  <span class="hljs-attr">spec:</span>
    <span class="hljs-attr">hostname:</span> <span class="hljs-string">controller.YOURDOMAIN.COM</span>

  <span class="hljs-attr">nodeSelector:</span>
    <span class="hljs-attr">worker-type:</span> <span class="hljs-string">controller</span>

<span class="hljs-attr">controller:</span>
  <span class="hljs-attr">image:</span>
    <span class="hljs-attr">repository:</span> <span class="hljs-string">YOUR-DOCKER-REGISTRY/controller</span>
    <span class="hljs-attr">tag:</span> <span class="hljs-string">YOUR-CONTAINER-TAG</span>

  <span class="hljs-attr">replicas:</span> <span class="hljs-number">2</span>

  <span class="hljs-attr">migration:</span>
    <span class="hljs-attr">new_handlers:</span> <span class="hljs-number">1</span>
    <span class="hljs-attr">new_mconfigs:</span> <span class="hljs-number">1</span>

  <span class="hljs-attr">nodeSelector:</span>
    <span class="hljs-attr">worker-type:</span> <span class="hljs-string">controller</span>

<span class="hljs-attr">metrics:</span>
  <span class="hljs-attr">imagePullSecrets:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">orc8r-secrets-registry</span>

  <span class="hljs-attr">metrics:</span>
    <span class="hljs-attr">volumes:</span>
      <span class="hljs-attr">prometheusData:</span>
        <span class="hljs-attr">volumeSpec:</span>
          <span class="hljs-attr">hostPath:</span>
            <span class="hljs-attr">path:</span> <span class="hljs-string">/prometheusData</span>
            <span class="hljs-attr">type:</span> <span class="hljs-string">DirectoryOrCreate</span>
      <span class="hljs-attr">prometheusConfig:</span>
        <span class="hljs-attr">volumeSpec:</span>
          <span class="hljs-attr">hostPath:</span>
            <span class="hljs-attr">path:</span> <span class="hljs-string">/configs/prometheus</span>
            <span class="hljs-attr">type:</span> <span class="hljs-string">DirectoryOrCreate</span>

  <span class="hljs-attr">prometheus:</span>
    <span class="hljs-attr">create:</span> <span class="hljs-literal">true</span>
    <span class="hljs-attr">nodeSelector:</span>
      <span class="hljs-attr">worker-type:</span> <span class="hljs-string">metrics</span>

  <span class="hljs-attr">configmanager:</span>
    <span class="hljs-attr">create:</span> <span class="hljs-literal">true</span>
    <span class="hljs-attr">image:</span>
      <span class="hljs-attr">repository:</span> <span class="hljs-string">YOUR-DOCKER-REGISTRY/config-manager</span>
      <span class="hljs-attr">tag:</span> <span class="hljs-string">YOUR-CONTAINER-TAG</span>
    <span class="hljs-attr">nodeSelector:</span>
      <span class="hljs-attr">worker-type:</span> <span class="hljs-string">metrics</span>

  <span class="hljs-attr">alertmanager:</span> 
    <span class="hljs-attr">create:</span> <span class="hljs-literal">true</span>
    <span class="hljs-attr">nodeSelector:</span>
      <span class="hljs-attr">worker-type:</span> <span class="hljs-string">metrics</span>

  <span class="hljs-attr">prometheusCache:</span>
    <span class="hljs-attr">create:</span> <span class="hljs-literal">true</span>
    <span class="hljs-attr">image:</span>
      <span class="hljs-attr">repository:</span> <span class="hljs-string">YOUR-DOCKER-REGISTRY/prometheus-cache</span>
      <span class="hljs-attr">tag:</span> <span class="hljs-string">YOUR-CONTAINER-TAG</span>
    <span class="hljs-attr">limit:</span> <span class="hljs-number">500000</span>
    <span class="hljs-attr">nodeSelector:</span>
      <span class="hljs-attr">worker-type:</span> <span class="hljs-string">metrics</span>

  <span class="hljs-attr">grafana:</span>
    <span class="hljs-attr">create:</span> <span class="hljs-literal">true</span>
    <span class="hljs-attr">image:</span>
      <span class="hljs-attr">repository:</span> <span class="hljs-string">YOUR-DOCKER-REGISTRY/grafana</span>
      <span class="hljs-attr">tag:</span> <span class="hljs-string">YOUR-CONTAINER-TAG</span>
    <span class="hljs-attr">nodeSelector:</span>
      <span class="hljs-attr">worker-type:</span> <span class="hljs-string">metrics</span>

<span class="hljs-attr">nms:</span>
  <span class="hljs-attr">imagePullSecrets:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">orc8r-secrets-registry</span>

  <span class="hljs-attr">magmalte:</span>
    <span class="hljs-attr">manifests:</span>
      <span class="hljs-attr">secrets:</span> <span class="hljs-literal">false</span>
      <span class="hljs-attr">deployment:</span> <span class="hljs-literal">false</span>
      <span class="hljs-attr">service:</span> <span class="hljs-literal">false</span>
      <span class="hljs-attr">rbac:</span> <span class="hljs-literal">false</span>

    <span class="hljs-attr">image:</span>
      <span class="hljs-attr">repository:</span> <span class="hljs-string">YOUR-DOCKER-REGISTRY/magmalte</span>
      <span class="hljs-attr">tag:</span> <span class="hljs-string">YOUR-CONTAINER-TAG</span>

    <span class="hljs-attr">env:</span>
      <span class="hljs-attr">api_host:</span> <span class="hljs-string">controller.YOURDOMAIN.COM</span>
      <span class="hljs-attr">mysql_host:</span> <span class="hljs-string">YOUR</span> <span class="hljs-string">RDS</span> <span class="hljs-string">MYSQL</span> <span class="hljs-string">HOST</span>
      <span class="hljs-attr">mysql_user:</span> <span class="hljs-string">magma</span>
      <span class="hljs-attr">mysql_pass:</span> <span class="hljs-string">YOUR</span> <span class="hljs-string">RDS</span> <span class="hljs-string">MYSQL</span> <span class="hljs-string">PASSWORD</span>
  <span class="hljs-attr">nginx:</span>
    <span class="hljs-attr">manifests:</span>
      <span class="hljs-attr">configmap:</span> <span class="hljs-literal">false</span>
      <span class="hljs-attr">secrets:</span> <span class="hljs-literal">false</span>
      <span class="hljs-attr">deployment:</span> <span class="hljs-literal">false</span>
      <span class="hljs-attr">service:</span> <span class="hljs-literal">false</span>
      <span class="hljs-attr">rbac:</span> <span class="hljs-literal">false</span>

    <span class="hljs-attr">service:</span>
      <span class="hljs-attr">type:</span> <span class="hljs-string">LoadBalancer</span>

    <span class="hljs-attr">deployment:</span>
      <span class="hljs-attr">spec:</span>
        <span class="hljs-attr">ssl_cert_name:</span> <span class="hljs-string">controller.crt</span>
        <span class="hljs-attr">ssl_cert_key_name:</span> <span class="hljs-string">controller.key</span>
</code></pre>
<p>NMS won't work without a client certificate, so we've turned off those
deployments for now. We'll create an admin cert and upgrade the deployment
with NMS once the core Orchestrator components are up.</p>
<p>At this point, if your <code>vals.yml</code> is good, you can do your first helm deploy:</p>
<pre><code class="hljs css language-bash"><span class="hljs-built_in">cd</span> magma/orc8r/cloud/helm/orc8r
helm install --name orc8r --namespace magma . --values=PATH_TO_VALS/vals.yml
</code></pre>
<h2><a class="anchor" aria-hidden="true" id="creating-an-admin-user"></a><a href="#creating-an-admin-user" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Creating an Admin User</h2>
<p>First, find a <code>orc8r-controller-</code> pod in k8s:</p>
<pre><code class="hljs css language-bash">$ kubectl -n magma get pods

NAME                                      READY   STATUS    RESTARTS   AGE
orc8r-configmanager-896d784bc-chqr7       1/1     Running   0          X
orc8r-controller-7757567bf5-cm4wn         1/1     Running   0          X
orc8r-controller-7757567bf5-jshpv         1/1     Running   0          X
orc8r-alertmanager-c8dc7cdb5-crzpl        1/1     Running   0          X
orc8r-grafana-6446b97885-ck6g8            1/1     Running   0          X
orc8r-prometheus-6c67bcc9d8-6lx22         1/1     Running   0          X
orc8r-prometheus-cache-6bf7648446-9t9hx   1/1     Running   0          X
orc8r-proxy-57cf989fcc-cg54z              1/1     Running   0          X
orc8r-proxy-57cf989fcc-xn2cw              1/1     Running   0          X
</code></pre>
<p>Then:</p>
<pre><code class="hljs css language-bash"><span class="hljs-built_in">export</span> CNTLR_POD=$(kubectl get pod -l app.kubernetes.io/component=controller -o jsonpath=<span class="hljs-string">'{.items[0].metadata.name}'</span>)
kubectl <span class="hljs-built_in">exec</span> -it <span class="hljs-variable">${CNTLR_POD}</span> bash

<span class="hljs-comment"># The following commands are to be run inside the pod</span>
(pod)$ <span class="hljs-built_in">cd</span> /var/opt/magma/bin
(pod)$ envdir /var/opt/magma/envdir ./accessc add-admin -cert admin_operator admin_operator
(pod)$ openssl pkcs12 -<span class="hljs-built_in">export</span> -out admin_operator.pfx -inkey admin_operator.key.pem -<span class="hljs-keyword">in</span> admin_operator.pem

Enter Export Password:
Verifying - Enter Export Password:

(pod)$ <span class="hljs-built_in">exit</span>
</code></pre>
<p>Now on your host, copy down the client certificates for the admin operator we
just created into the secrets directory:</p>
<pre><code class="hljs css language-bash"><span class="hljs-built_in">cd</span> ~/secrets/certs
<span class="hljs-keyword">for</span> certfile <span class="hljs-keyword">in</span> admin_operator.pem admin_operator.key.pem admin_operator.pfx
<span class="hljs-keyword">do</span>
    kubectl cp <span class="hljs-variable">${CNTLR_POD}</span>:/var/opt/magma/bin/<span class="hljs-variable">${certfile}</span> ./<span class="hljs-variable">${certfile}</span>
<span class="hljs-keyword">done</span>
</code></pre>
<p><code>admin_operator.pem</code> and <code>admin_operator.key.pem</code> are the files that NMS will
use to authenticate itself with the Orchestrator API. <code>admin_operator.pfx</code> is
for you to add to your keychain if you'd like to use the Orchestrator REST API
directly (on MacOS, double-click this file and add it to your keychain).</p>
<h2><a class="anchor" aria-hidden="true" id="deploying-nms"></a><a href="#deploying-nms" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Deploying NMS</h2>
<p>Now that we've got an admin operator cert, we can deploy NMS. Edit the
<code>vals.yml</code> from above, and change the <code>nms</code> section to the following:</p>
<pre><code class="hljs"><span class="hljs-attr">nms:</span>
  <span class="hljs-attr">imagePullSecrets:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">orc8r-secrets-registry</span>

  <span class="hljs-attr">magmalte:</span>
    <span class="hljs-attr">manifests:</span>
      <span class="hljs-attr">secrets:</span> <span class="hljs-literal">true</span>
      <span class="hljs-attr">deployment:</span> <span class="hljs-literal">true</span>
      <span class="hljs-attr">service:</span> <span class="hljs-literal">true</span>
      <span class="hljs-attr">rbac:</span> <span class="hljs-literal">false</span>

    <span class="hljs-attr">image:</span>
      <span class="hljs-attr">repository:</span> <span class="hljs-string">YOUR-DOCKER-REGISTRY/magmalte</span>
      <span class="hljs-attr">tag:</span> <span class="hljs-string">YOUR-CONTAINER-TAG</span>

    <span class="hljs-attr">env:</span>
      <span class="hljs-attr">api_host:</span> <span class="hljs-string">controller.YOURDOMAIN.COM</span>
      <span class="hljs-attr">mysql_host:</span> <span class="hljs-string">YOUR</span> <span class="hljs-string">RDS</span> <span class="hljs-string">MYSQL</span> <span class="hljs-string">HOST</span>
      <span class="hljs-attr">mysql_user:</span> <span class="hljs-string">magma</span>
      <span class="hljs-attr">mysql_pass:</span> <span class="hljs-string">YOUR</span> <span class="hljs-string">RDS</span> <span class="hljs-string">MYSQL</span> <span class="hljs-string">PASSWORD</span>
  <span class="hljs-attr">nginx:</span>
    <span class="hljs-attr">manifests:</span>
      <span class="hljs-attr">configmap:</span> <span class="hljs-literal">true</span>
      <span class="hljs-attr">secrets:</span> <span class="hljs-literal">true</span>
      <span class="hljs-attr">deployment:</span> <span class="hljs-literal">true</span>
      <span class="hljs-attr">service:</span> <span class="hljs-literal">true</span>
      <span class="hljs-attr">rbac:</span> <span class="hljs-literal">false</span>

    <span class="hljs-attr">service:</span>
      <span class="hljs-attr">type:</span> <span class="hljs-string">LoadBalancer</span>

    <span class="hljs-attr">deployment:</span>
      <span class="hljs-attr">spec:</span>
        <span class="hljs-attr">ssl_cert_name:</span> <span class="hljs-string">controller.crt</span>
        <span class="hljs-attr">ssl_cert_key_name:</span> <span class="hljs-string">controller.key</span>
</code></pre>
<p>You'll just flip all the <code>manifests</code> keys to <code>true</code> except <code>rbac</code>.</p>
<p>Next, copy your <code>secrets</code> directory back to the chart (to pick up the admin
certificate), and upload to to S3 (this step is optional, but you should have
some story for where you're storing these).</p>
<pre><code class="hljs css language-bash">rm -r magma/orc8r/cloud/helm/orc8r/charts/secrets/.secrets
cp -r ~/secrets magma/orc8r/cloud/helm/orc8r/charts/secrets/.secrets
aws s3 cp magma/orc8r/helm/orc8r/charts/secrets/.secrets s3://your-bucket --recursive
<span class="hljs-comment"># Delete the local secrets after you've uploaded them</span>
rm -r ~/secrets
</code></pre>
<p>We can upgrade the Helm deployment to include NMS components now:</p>
<pre><code class="hljs css language-bash"><span class="hljs-built_in">cd</span> magma/orc8r/cloud/helm/orc8r
helm upgrade orc8r . --values=PATH_TO_VALS/vals.yml
kubectl -n magma get pods
</code></pre>
<p>Wait for the NMS pods (<code>nms-magmalte</code>, <code>nms-nginx-proxy</code>) to transition into
<code>Running</code> state, then create a user on the NMS:</p>
<pre><code class="hljs css language-bash">kubectl <span class="hljs-built_in">exec</span> -it -n magma \
  $(kubectl get pod -l app.kubernetes.io/component=magmalte -o jsonpath=<span class="hljs-string">'{.items[0].metadata.name}'</span>) -- \
  yarn setAdminPassword &lt;admin user email&gt; &lt;admin user password&gt;
</code></pre>
<h2><a class="anchor" aria-hidden="true" id="upgrading-the-deployment"></a><a href="#upgrading-the-deployment" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Upgrading the Deployment</h2>
<p>We recommend an upgrade procedure along these lines:</p>
<ol>
<li><code>git checkout</code> the tag of the most recent release on Github</li>
<li>Rebuild all the images and push them</li>
<li>Update the image tags in vals.yml</li>
<li><code>aws s3 cp</code> the secrets bucket in S3 into <code>.secrets</code> under the secrets
subchart in Magma</li>
<li>Upgrade helm deployment with <code>helm upgrade</code></li>
<li>Delete the <code>.secrets</code> folder</li>
</ol>
<p>We've automated steps 4-6 with a fabfile under
<code>magma/orc8r/cloud/helm/orc8r/fabfile.py</code>. You can upgrade your deployment
using this fabfile like this:</p>
<pre><code class="hljs css language-bash">fab deploy:PATH_TO_VALS_YML,PATH_TO_TERRAFORM_KUBECONFIG,S3_BUCKET_NAME
</code></pre>
<p>where <code>PATH_TO_VALS_YML</code> is the full path to <code>vals.yml</code> on your machine,
<code>PATH_TO_TERRAFORM_KUBECONFIG</code> is the full path to the <code>kubeconfig_orc8r</code> file
produced by Terraform, and <code>S3_BUCKET_NAME</code> is the name of the S3 bucket where
you've uploaded your secrets.</p>
</span></div></article></div><div class="docs-prevnext"><a class="docs-prev button" href="/magma/docs/next/orc8r/deploy_terraform"><span class="arrow-prev">← </span><span>Terraforming Orchestrator on AWS</span></a><a class="docs-next button" href="/magma/docs/next/orc8r/deploy_dns"><span>DNS Resolution</span><span class="arrow-next"> →</span></a></div></div></div><nav class="onPageNav"><ul class="toc-headings"><li><a href="#creating-secrets">Creating Secrets</a><ul class="toc-headings"><li><a href="#ssl-certificates">SSL Certificates</a></li><li><a href="#application-certificates-and-keys">Application Certificates and Keys</a></li><li><a href="#environment-secrets">Environment Secrets</a></li><li><a href="#static-configuration-files">Static Configuration Files</a></li></ul></li><li><a href="#initial-helm-deploy">Initial Helm Deploy</a></li><li><a href="#creating-an-admin-user">Creating an Admin User</a></li><li><a href="#deploying-nms">Deploying NMS</a></li><li><a href="#upgrading-the-deployment">Upgrading the Deployment</a></li></ul></nav></div><footer class="nav-footer" id="footer"><section class="sitemap"><a href="/magma/" class="nav-home"><img src="/magma/img/fb.png" alt="Magma" width="66" height="58"/></a><div><h5>Docs</h5><a href="https://github.com/facebookincubator/magma/blob/master/docs/Magma_Product_Overview.pdf">Magma Product Overview</a><a href="https://github.com/facebookincubator/magma/blob/master/docs/Magma_Specs_V1.1.pdf">Magma Spec</a></div><div><h5>Community</h5><a href="https://discord.gg/4YxZbft">Discord</a><a href="https://fb.me/magmadevsummit" target="_blank" rel="noreferrer noopener">Magma Dev Summit</a></div><div><h5>More</h5><a href="https://code.fb.com/open-source/magma/">Blog</a><a href="https://github.com/facebookincubator/magma">GitHub</a></div></section><a href="https://code.facebook.com/projects/" target="_blank" rel="noreferrer noopener" class="fbOpenSource"><img src="/magma/img/oss_logo.png" alt="Facebook Open Source" width="170" height="45"/></a><section class="copyright">Copyright © 2020 Facebook</section></footer></div></body></html>