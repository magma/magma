<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><title>proposals/p008_mandatory_integration_tests_for_each_PR · Magma Documentation</title><meta name="viewport" content="width=device-width"/><meta name="generator" content="Docusaurus"/><meta name="description" content="id: p006_mandatory_integration_tests_for_each_PR.md"/><meta name="docsearch:version" content="next"/><meta name="docsearch:language" content="en"/><meta property="og:title" content="proposals/p008_mandatory_integration_tests_for_each_PR · Magma Documentation"/><meta property="og:type" content="website"/><meta property="og:url" content="https://magma.github.io/magma/"/><meta property="og:description" content="id: p006_mandatory_integration_tests_for_each_PR.md"/><meta property="og:image" content="https://magma.github.io/magma/img/docusaurus.png"/><meta name="twitter:card" content="summary"/><meta name="twitter:image" content="https://magma.github.io/magma/img/docusaurus.png"/><link rel="shortcut icon" href="/magma/img/icon.png"/><link rel="stylesheet" href="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.css"/><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css"/><script type="text/javascript" src="https://buttons.github.io/buttons.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script><script type="text/javascript" src="/init.js"></script><script src="/magma/js/scrollSpy.js"></script><link rel="stylesheet" href="/magma/css/main.css"/><script src="/magma/js/codetabs.js"></script></head><body class="sideNavVisible separateOnPageNav"><div class="fixedHeaderContainer"><div class="headerWrapper wrapper"><header><a href="/magma/"><img class="logo" src="/magma/img/magma-logo.svg" alt="Magma Documentation"/><h2 class="headerTitleWithLogo">Magma Documentation</h2></a><a href="/magma/versions"><h3>next</h3></a><div class="navigationWrapper navigationSlider"><nav class="slidingNav"><ul class="nav-site nav-site-internal"><li class=""><a href="https://magmacore.org" target="_self">Home</a></li><li class=""><a target="_self"> | </a></li><li class=""><a href="/magma/" target="_self">Docs</a></li><li class=""><a target="_self"> | </a></li><li class=""><a href="https://github.com/magma" target="_self">Code</a></li><li class=""><a target="_self"> | </a></li><li class=""><a href="https://magmacore.org/community" target="_self">Community</a></li><li class="navSearchWrapper reactNavSearchWrapper"><input type="text" id="search_input_react" placeholder="Search" title="Search"/></li></ul></nav></div></header></div></div><div class="navPusher"><div class="docMainWrapper wrapper"><div class="container mainContainer docsContainer"><div class="wrapper"><div class="post"><header class="postHeader"><h1 id="__docusaurus" class="postHeaderTitle">proposals/p008_mandatory_integration_tests_for_each_PR</h1></header><article><div><span><p>id: p006_mandatory_integration_tests_for_each_PR.md
title: Enable integration tests as a mandatory check required to merge any PR
hide_title: true
---# Enable integration tests as a mandatory check required to merge any PR</p>
<ul>
<li>Feature owners: <code>@119vik</code>, <code>@tdzik</code>, <code>@mattymo</code></li>
<li>Feedback requested from: <code>@apad</code>, <code>@zer0tweets</code>, <code>@ttx</code></li>
</ul>
<h2><a class="anchor" aria-hidden="true" id="problem-descriptions"></a><a href="#problem-descriptions" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Problem descriptions</h2>
<p>At the moment, buggy codes gets merged into master branch time after time, which affects development of new features, slowing developers down. This happens because some PRs get merged without performing proper QA by the code maintainers who are not willing to wait until integration tests have executed. Here are some numbers which can explain what does &quot;wait too long&quot; means:</p>
<ul>
<li>magma_integration_tests pipeline takes ~1 hour to execute and Jenkins can process only 1 run/hour (does not support concurrent builds)</li>
<li>existing test env is a VirtualBox VMs managed by Vagrant on top of KVM VMs which are running on baremetall node is very slow.</li>
<li>average magma_integration_tests queue length was 30-40 jobs (before opt-in strategy was implemented)</li>
<li>CWAG-integration-test and LTE-integration-test jobs take 1 hour each (before optimisation.) Jenkins can process approximtely 13 executions per hour.
Recently we switched to &quot;Opt-In strategy&quot; for PRs affecting the gateway code base. These PRs must be marked with one of the following labels: &quot;component: agw&quot; OR &quot;component: cwf&quot; OR &quot;component: feg&quot;. Implementation of this strategy decreased load on jenkins (went from 30+ to 2-10 per day). At the same time, this means that PRs which were not marked with the correct label are not tested and may be introducing new bugs.</li>
</ul>
<p>We can draw a conclusion from above and outline the following pain points:</p>
<ul>
<li>Some PRs are still merged into master without integration tests</li>
<li>Integration tests are slow (actual execution is slow, regardless of VM setup time) so we can't realistically run them for each commit of each PR.</li>
<li>Reviewers are not applying tags to PRs and waiting for them to complete (or skipping gatekeeping tests)</li>
<li>Magma_integration_tests pipeline is the largest bottleneck in our CI process</li>
</ul>
<h2><a class="anchor" aria-hidden="true" id="proposed-solutions"></a><a href="#proposed-solutions" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Proposed solutions</h2>
<h3><a class="anchor" aria-hidden="true" id="integration-tests-are-slowwhich-is-more-or-less-expected-so-we-cant-run-them-for-each-commit-of-each-pr"></a><a href="#integration-tests-are-slowwhich-is-more-or-less-expected-so-we-cant-run-them-for-each-commit-of-each-pr" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Integration tests are slow(which is more or less expected) so we can't run them for each commit of each PR.</h3>
<p>We should execute integration tests for each and every PR which is going to be merged in to master. But there's no sense to do it for each and every commit.
Solution
Stage 1:</p>
<ul>
<li>Ensure that for each commit of each PR all unit test jobs are executed by CircleCI</li>
<li>Ensure that each PR was reviewed and accepted by component maintainer</li>
<li>Ensure that each PR which succesfully passed unit testing and maintainer review gets &quot;ready-to-merge&quot; label assigned.</li>
<li>Ensure that each PR marked with label &quot;ready-to-merge&quot; was tested by all integration tests.
Stage 2:</li>
<li>Ensure that each PR marked with label &quot;ready-to-merge&quot;, which passed integration tests is automatically merged by CI.
Stage 3:</li>
<li>Ensure that no side effects appear when PRs are automatically merged by CI (so speculative CI implementation in fact).</li>
</ul>
<h3><a class="anchor" aria-hidden="true" id="some-prs-are-still-merged-into-master-without-integration-tests"></a><a href="#some-prs-are-still-merged-into-master-without-integration-tests" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Some PRs are still merged into master without integration tests</h3>
<p>Make Jenkins as a mandatory gatekeeper for merging each PR. Proposed workflow:</p>
<ul>
<li>Reviewer marks appropriate labels to run necessary relevant tests (such as CWAG / NMS / etc.) before indicating &quot;ready-to-merge&quot; (tag or some keyword in a comment)</li>
<li>Jenkins triggers all tests</li>
<li>When all jobs are green, Jenkins merges the PR (or alternatively set a test result &quot;Jenkins CI Gate: Passed&quot;)</li>
</ul>
<h3><a class="anchor" aria-hidden="true" id="reviewers-are-not-applying-tags-to-prs-and-waiting-for-them-to-complete-or-skipping-gatekeeping-tests"></a><a href="#reviewers-are-not-applying-tags-to-prs-and-waiting-for-them-to-complete-or-skipping-gatekeeping-tests" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Reviewers are not applying tags to PRs and waiting for them to complete (or skipping gatekeeping tests)</h3>
<p>We run twice daily(EU time / US night time) master branch regression test builds (all tests) and look for regressions that could have gotten merged into master. Regressions can happen for the following reasons:</p>
<ul>
<li>Reviewer did not wait for tests</li>
<li>Two conflicting PRs were merged that had logic that breaks something</li>
<li>External factors not covered by PR process (such as a library package update)
This regression pipeline runs twice a day(EU time / US night time) on a schedule. If the build fails, a GitHub issue is created tagging Magma CI team for urgent attention.</li>
</ul>
<h3><a class="anchor" aria-hidden="true" id="magma_integration_tests-pipeline-is-the-largest-bottleneck-in-our-ci-process"></a><a href="#magma_integration_tests-pipeline-is-the-largest-bottleneck-in-our-ci-process" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Magma_integration_tests pipeline is the largest bottleneck in our CI process</h3>
<p>At the moment magma_integration_tests pipeline is structured in such a way that it's using a Jenkins slave as a jump host to a real test environment. We only have one real test env for the magma_integration_tests for now. We need to do some simple refactoring to ensure that magma_integration_tests utilizes a Jenkins slave as a real test env (like CWAG and LTE integration tests do). This means replacing all the 'ssh <user>@<host> - '<command>'' with corresponding 'sh <command> ' statements in the pipeline definition. This simple refactoring should allow Jenkins to handle up to 16 builds per hour (instead of just 1 at the present moment).</p>
<h3><a class="anchor" aria-hidden="true" id="existing-test-env-is-a-virtualbox-vms-managed-by-vagrant-on-top-of-kvm-vms-which-are-running-on-baremetall-node-is-very-slow"></a><a href="#existing-test-env-is-a-virtualbox-vms-managed-by-vagrant-on-top-of-kvm-vms-which-are-running-on-baremetall-node-is-very-slow" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Existing test env is a VirtualBox VMs managed by Vagrant on top of KVM VMs which are running on baremetall node is very slow.</h3>
<p>As we found as a result of performance tests current setup gives us low performace because of Virtualbox running in KVM. Best option we can suggest so far is start using libvirt based vagrant boxes which 2-3 times faster then Virtualbox.</p>
<h2><a class="anchor" aria-hidden="true" id="execution-plan"></a><a href="#execution-plan" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Execution plan</h2>
<p>Steps:</p>
<ul>
<li>Refactor magma_integration_tests to enable concurrent execution for multiple PRs</li>
<li>Prepare Jenkins pipeline which can build libvirt boxes for vagrant and publish using community account.</li>
<li>Refactor all existing pipelines to use libvirt vagrant boxes.</li>
<li>Configure Jenkins to run Nightly Builds against master with All integration tests</li>
<li>Configure Jenkins to run All Integration tests against any PR marked with &quot;ready-to-merge&quot; label</li>
<li>Configure Jenkins to raise an Github Issue in case of nightly build failure</li>
<li>Configure Jenkins to merge PR when all integration tests passed for any PR marked with &quot;ready-to-merge&quot; label</li>
</ul>
<p>Optional Steps:</p>
<ul>
<li>Setup Speculative CI. CI which can merge several PRs together in temporary branch - confirm that code is still stable with unit and integration tests and merge temporary branch into master.</li>
</ul>
</span></div></article></div><div class="docs-prevnext"></div></div></div><nav class="onPageNav"><ul class="toc-headings"><li><a href="#problem-descriptions">Problem descriptions</a></li><li><a href="#proposed-solutions">Proposed solutions</a><ul class="toc-headings"><li><a href="#integration-tests-are-slowwhich-is-more-or-less-expected-so-we-cant-run-them-for-each-commit-of-each-pr">Integration tests are slow(which is more or less expected) so we can't run them for each commit of each PR.</a></li><li><a href="#some-prs-are-still-merged-into-master-without-integration-tests">Some PRs are still merged into master without integration tests</a></li><li><a href="#reviewers-are-not-applying-tags-to-prs-and-waiting-for-them-to-complete-or-skipping-gatekeeping-tests">Reviewers are not applying tags to PRs and waiting for them to complete (or skipping gatekeeping tests)</a></li><li><a href="#magma_integration_tests-pipeline-is-the-largest-bottleneck-in-our-ci-process">Magma_integration_tests pipeline is the largest bottleneck in our CI process</a></li><li><a href="#existing-test-env-is-a-virtualbox-vms-managed-by-vagrant-on-top-of-kvm-vms-which-are-running-on-baremetall-node-is-very-slow">Existing test env is a VirtualBox VMs managed by Vagrant on top of KVM VMs which are running on baremetall node is very slow.</a></li></ul></li><li><a href="#execution-plan">Execution plan</a></li></ul></nav></div><footer class="nav-footer" id="footer"><section class="sitemap"><a href="/magma/" class="nav-home"><img src="/magma/img/magma_icon.png" alt="Magma Documentation" width="66"/></a><div><h5>Docs</h5><a href="https://github.com/facebookincubator/magma/blob/master/docs/Magma_Product_Overview.pdf">Magma Product Overview</a><a href="https://github.com/facebookincubator/magma/blob/master/docs/Magma_Specs_V1.1.pdf">Magma Spec</a></div><div><h5>Community</h5><a href="https://discord.gg/4YxZbft">Discord</a><a href="https://fb.me/magmadevsummit" target="_blank" rel="noreferrer noopener">Magma Dev Summit</a></div><div><h5>More</h5><a href="https://code.fb.com/open-source/magma/">Blog</a><a href="https://github.com/facebookincubator/magma">GitHub</a></div></section><section class="copyright">Copyright © 2021 The Magma Authors</section></footer></div><script type="text/javascript" src="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.js"></script><script>
                document.addEventListener('keyup', function(e) {
                  if (e.target !== document.body) {
                    return;
                  }
                  // keyCode for '/' (slash)
                  if (e.keyCode === 191) {
                    const search = document.getElementById('search_input_react');
                    search && search.focus();
                  }
                });
              </script><script>
              var search = docsearch({
                
                apiKey: 'f95caeb7bc059b294eec88e340e5445b',
                indexName: 'magma',
                inputSelector: '#search_input_react'
              });
            </script></body></html>