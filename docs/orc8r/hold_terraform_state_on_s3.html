<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><title>Hold Terraform state outside my local machine · Magma Documentation</title><meta name="viewport" content="width=device-width, initial-scale=1.0"/><meta name="generator" content="Docusaurus"/><meta name="description" content="# Holding the terraform state outside of my local machine"/><meta name="docsearch:version" content="1.6.0"/><meta name="docsearch:language" content="en"/><meta property="og:title" content="Hold Terraform state outside my local machine · Magma Documentation"/><meta property="og:type" content="website"/><meta property="og:url" content="https://magma.github.io/magma/"/><meta property="og:description" content="# Holding the terraform state outside of my local machine"/><meta property="og:image" content="https://magma.github.io/magma/img/docusaurus.png"/><meta name="twitter:card" content="summary"/><meta name="twitter:image" content="https://magma.github.io/magma/img/docusaurus.png"/><link rel="shortcut icon" href="/magma/img/icon.png"/><link rel="stylesheet" href="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.css"/><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css"/><script type="text/javascript" src="https://buttons.github.io/buttons.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script><script type="text/javascript" src="/init.js"></script><script src="/magma/js/scrollSpy.js"></script><link rel="stylesheet" href="/magma/css/main.css"/><script src="/magma/js/codetabs.js"></script></head><body class="sideNavVisible separateOnPageNav"><div class="fixedHeaderContainer"><div class="headerWrapper wrapper"><header><a href="/magma/"><img class="logo" src="/magma/img/magma-logo.svg" alt="Magma Documentation"/><h2 class="headerTitleWithLogo">Magma Documentation</h2></a><a href="/magma/versions"><h3>1.6.0</h3></a><div class="navigationWrapper navigationSlider"><nav class="slidingNav"><ul class="nav-site nav-site-internal"><li class=""><a href="https://magmacore.org" target="_self">Home</a></li><li class=""><a target="_self"> | </a></li><li class=""><a href="/magma/" target="_self">Docs</a></li><li class=""><a target="_self"> | </a></li><li class=""><a href="https://github.com/magma" target="_self">Code</a></li><li class=""><a target="_self"> | </a></li><li class=""><a href="https://magmacore.org/community" target="_self">Community</a></li><li class="navSearchWrapper reactNavSearchWrapper"><input type="text" id="search_input_react" placeholder="Search" title="Search"/></li></ul></nav></div></header></div></div><div class="navPusher"><div class="docMainWrapper wrapper"><div class="container mainContainer docsContainer"><div class="wrapper"><div class="post"><header class="postHeader"></header><article><div><span><h1><a class="anchor" aria-hidden="true" id="holding-the-terraform-state-outside-of-my-local-machine"></a><a href="#holding-the-terraform-state-outside-of-my-local-machine" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Holding the terraform state outside of my local machine</h1>
<p><strong>Description:</strong> It is best to not hold the terraform state file locally on any disk that is susceptible to local failures and loss of state file. Note that the state file is the blueprint of the assets deployed on the public cloud environment and if this gets corrupt, it will be very difficult to manage cloud assets in a programmatic manner.</p>
<p>To aid this vision, terraform supports holding the state file remotely. One example is to use the AWS S3 bucket to store the state file. However, in such a scenario, it is plausible that more than one user may try to access the state file at the same time. For this reason, we can use a dynamo database to lock the database when it is being read and written to</p>
<p><strong>Environment:</strong> Orc8r in AWS/EKS</p>
<p><strong>Components:</strong> Orchestrator</p>
<p><strong>Steps:</strong></p>
<p>High level steps:</p>
<ol>
<li><p><a href="https://docs.aws.amazon.com/AmazonS3/latest/user-guide/create-bucket.html">Create an S3 bucket</a></p></li>
<li><p><a href="https://www.terraform.io/docs/language/settings/backends/s3.html#dynamodb-state-locking">Create a dynamo dB state locking</a></p></li>
<li><p>Add configuration to the main.tf file under <code>module orc8r-app</code> to change the backend(variables <code>state_backend</code> and <code>state_config</code>)</p></li>
</ol>
<pre><code class="hljs"><span class="hljs-attr">state_backend</span> = <span class="hljs-string">"s3"</span>
<span class="hljs-attr">state_config</span> = {
    <span class="hljs-attr">bucket</span> = <span class="hljs-string">"s3_bucket_name"</span>
    <span class="hljs-attr">region</span> = <span class="hljs-string">"us-west-2"</span>
    <span class="hljs-attr">dynamodb_table</span> = <span class="hljs-string">"dynamo_table_name"</span>
    <span class="hljs-attr">key</span> = <span class="hljs-string">"terraform/terraform.tfstate"</span>
}
</code></pre>
<p>In the same main.tf file, add the below configuration:</p>
<pre><code class="hljs">output <span class="hljs-string">"nameservers"</span> {
    <span class="hljs-keyword">value</span> = <span class="hljs-keyword">module</span>.orc<span class="hljs-number">8</span>r.route<span class="hljs-number">53_n</span>ameservers
}
</code></pre>
<p>Similarly, at the top of the main.tf file, you can add the following per instructions in the <a href="https://www.terraform.io/docs/backends/types/s3.html#example-configuration">hashicorp instructions</a></p>
<pre><code class="hljs">terraform {
    <span class="hljs-attr">required_version</span> = <span class="hljs-string">"&gt;= 0.12.0"</span>
    backend <span class="hljs-string">"s3"</span> {
    <span class="hljs-attr">bucket</span> = <span class="hljs-string">"s3_bucket_name"</span>
    <span class="hljs-attr">dynamodb_table</span> = <span class="hljs-string">"dynamo_table_name"</span>
    <span class="hljs-attr">encrypt</span> = <span class="hljs-literal">true</span>
    <span class="hljs-attr">key="terraform/terraform.tfstate"</span>
    <span class="hljs-attr">region="us-west-2"</span>
    }
}
</code></pre>
<p>Next time you run terraform init, you will be asked if you would like to migrate. Follow the instructions (starting at
step 6) <a href="https://www.terraform.io/docs/cloud/migrate/index.html#step-6-run-terraform-init-to-migrate-the-workspace">here</a> to finish the migration.</p>
<p>At this point, you can go check your s3 bucket and validate that you have content written there and it should be
the state file for your deployment!</p>
</span></div></article></div><div class="docs-prevnext"></div></div></div><nav class="onPageNav"></nav></div><footer class="nav-footer" id="footer"><section class="sitemap"><a href="/magma/" class="nav-home"><img src="/magma/img/magma_icon.png" alt="Magma Documentation" width="66"/></a><div><h5>Docs</h5><a href="https://github.com/facebookincubator/magma/blob/master/docs/Magma_Product_Overview.pdf">Magma Product Overview</a><a href="https://github.com/facebookincubator/magma/blob/master/docs/Magma_Specs_V1.1.pdf">Magma Spec</a></div><div><h5>Community</h5><a href="https://discord.gg/4YxZbft">Discord</a><a href="https://fb.me/magmadevsummit" target="_blank" rel="noreferrer noopener">Magma Dev Summit</a></div><div><h5>More</h5><a href="https://code.fb.com/open-source/magma/">Blog</a><a href="https://github.com/facebookincubator/magma">GitHub</a></div></section><section class="copyright">Copyright © 2021 The Magma Authors</section></footer></div><script type="text/javascript" src="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.js"></script><script>
                document.addEventListener('keyup', function(e) {
                  if (e.target !== document.body) {
                    return;
                  }
                  // keyCode for '/' (slash)
                  if (e.keyCode === 191) {
                    const search = document.getElementById('search_input_react');
                    search && search.focus();
                  }
                });
              </script><script>
              var search = docsearch({
                
                apiKey: 'f95caeb7bc059b294eec88e340e5445b',
                indexName: 'magma',
                inputSelector: '#search_input_react'
              });
            </script></body></html>