name: DP Integration tests on AWS

on:
  pull_request:
    branches:
      - "cl_develop"
  push:
    branches:
      - "!cl_develop"

jobs:
  integation_tests_on_aws:
    name: "All"
    runs-on: ubuntu-latest
    continue-on-error: true
    defaults:
      run:
        working-directory: dp
    env:
      TEST_DIR: /tmp/integration-tests-results
      SKAFFOLD_DEFAULT_REPO: docker.io/${{ secrets.DP_DOCKERHUB_USERNAME }}
      AWS_REGION_CODE: us-west-2
      EKS_CLUSTER_NAME: dp_orc8r
      TERM: xterm
      #AWS_ACCESS_KEY_ID: ${{ secrets.DP_AWS_ACCESS_KEY_ID }}
      #AWS_SECRET_ACCESS_KEY: ${{ secrets.DP_AWS_SECRET_ACCESS_KEY }}
     
    strategy:
      fail-fast: false
    steps:
    - uses: actions/checkout@v2
    - name: Install kubectx
      run: |
        sudo git clone https://github.com/ahmetb/kubectx /opt/kubectx
        sudo ln -s /opt/kubectx/kubectx /usr/local/bin/kubectx
        sudo ln -s /opt/kubectx/kubens /usr/local/bin/kubens
        kubectx -h
        kubens -h
    - name: Login to Docker Hub
      uses: docker/login-action@v1
      with:
        username: ${{ secrets.DP_DOCKERHUB_USERNAME }}
        password: ${{ secrets.DP_DOCKERHUB_TOKEN }}

    #- name: Get minikube IP and prepare directory for test results
    #  run: |
    #    minikube ip
    #    mkdir -p $TEST_DIR
    #    minikube mount $TEST_DIR:$TEST_DIR &

    #- name: Run integration tests
    #  run: | 
    #    make _ci_integration_tests

    #- name: Upload integration test results
    #  if: always()
    #  uses: actions/upload-artifact@v2
    #  with:
    #    name: integration-tests-results
    #    path: ${{ env.TEST_DIR }}
