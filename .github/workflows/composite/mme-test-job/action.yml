---
name: mme-test-job

inputs:
  DEVCONTAINER_IMAGE:
    description: "the docker image tag to test"
    required: true
  MAGMA_ROOT:
    description: "should be set to github.workspace"
    required: true
  SLACK_WEBHOOK_CI:
    description: "slack webhook ci"
    required: true

runs:
  using: "composite"
  steps:
    - uses: actions/checkout@v2
    - name: Run sctpd tests with Debug build type
      uses: addnab/docker-run-action@v2
      with:
        image: ${{ inputs.DEVCONTAINER_IMAGE }}
        # TODO: Remove work-around mount of Github workspace to /magma (https://github.com/addnab/docker-run-action/issues/11)
        options: --volume ${{ inputs.MAGMA_ROOT }}:/workspaces/magma --volume ${{ inputs.MAGMA_ROOT }}/lte/gateway/configs:/etc/magma -e ABC=123
        run: |
          cd /workspaces/magma/lte/gateway
          make test_sctpd BUILD_TYPE=Debug
    - name: Run sctpd tests with RelWithDebInfo build type
      uses: addnab/docker-run-action@v2
      with:
        image: ${{ inputs.DEVCONTAINER_IMAGE }}
        # TODO: Remove work-around mount of Github workspace to /magma (https://github.com/addnab/docker-run-action/issues/11)
        options: --volume ${{ inputs.MAGMA_ROOT }}:/workspaces/magma --volume ${{ inputs.MAGMA_ROOT }}/lte/gateway/configs:/etc/magma -e ABC=123
        run: |
          cd /workspaces/magma/lte/gateway
          make test_sctpd BUILD_TYPE=RelWithDebInfo
    - name: Run mme tests with Debug build type
      uses: addnab/docker-run-action@v2
      with:
        image: ${{ inputs.DEVCONTAINER_IMAGE }}
        # TODO: Remove work-around mount of Github workspace to /magma (https://github.com/addnab/docker-run-action/issues/11)
        options: --volume ${{ inputs.MAGMA_ROOT }}:/workspaces/magma --volume ${{ inputs.MAGMA_ROOT }}/lte/gateway/configs:/etc/magma -e ABC=123
        run: |
          cd /workspaces/magma/lte/gateway
          make test_oai BUILD_TYPE=Debug;
    - name: Run mme tests with RelWithDebInfo build type
      uses: addnab/docker-run-action@v2
      with:
        image: ${{ inputs.DEVCONTAINER_IMAGE }}
        # TODO: Remove work-around mount of Github workspace to /magma (https://github.com/addnab/docker-run-action/issues/11)
        options: --volume ${{ inputs.MAGMA_ROOT }}:/workspaces/magma --volume ${{ inputs.MAGMA_ROOT }}/lte/gateway/configs:/etc/magma -e ABC=123
        run: |
          cd /workspaces/magma/lte/gateway
          make test_oai BUILD_TYPE=RelWithDebInfo;
    - name: Extract commit title
      # yamllint enable
      if: failure() && github.event_name == 'push'
      id: commit
      shell: bash
      run: |
          str="$(jq '.head_commit.message' $GITHUB_EVENT_PATH)"    # get the head_commit message
          echo ::set-output name=title::${str%%\\n*} | tr -d '"'
    - name: Notify failure to slack
      if: failure() && github.event_name == 'push'
      uses: rtCamp/action-slack-notify@v2.2.0
      env:
        SLACK_WEBHOOK: ${{ inputs.SLACK_WEBHOOK }}
        SLACK_TITLE: "Github action mme_test failed"
        SLACK_USERNAME: "AGW workflow"
        SLACK_MESSAGE: "${{ steps.commit.outputs.title}}"
        SLACK_ICON_EMOJI: ":boom:"
        SLACK_COLOR: "#FF0000"
        SLACK_FOOTER: ' '
