# Copyright 2022 The Magma Authors.
#
# This source code is licensed under the BSD-style license found in the
# LICENSE file in the root directory of this source tree.
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

name: Magma Build & Publish

on:
  workflow_dispatch: null
  push:
    branches:
      - master
      - 'v1.*'
  pull_request:
    branches:
      - master
      - 'v1.*'
    types: [ opened, reopened, synchronize ]
jobs:
  build_publish_helm_charts:
    if: github.repository_owner == 'magma'
    env:
      HELM_CHART_ARTIFACTORY_URL: "https://linuxfoundation.jfrog.io/artifactory/"
      HELM_CHART_MUSEUM_REPO: magma-helm-test
      HELM_CHART_MUSEUM_USERNAME: "${{ secrets.LF_JFROG_USERNAME }}"
      HELM_CHART_MUSEUM_TOKEN: "${{ secrets.LF_JFROG_PASSWORD }}"
      MAGMA_ROOT: "${{ github.workspace }}"
      EVENT_NAME: "${{ github.event_name }}"
      ISSUE_NUMBER: "${{ github.event.number }}"
    runs-on: ubuntu-20.04
    steps:
      - uses: actions/checkout@93ea575cb5d8a053eaa0ac8fa3b40d7e05a33cc8 # pin@v3.1.0
      # Version is github job run number when running on master
      # Or is branch name when on release branch
      - name: Set Helm chart version
        run: |
          if [ "${GITHUB_REF}" = "refs/heads/master" ] ;then
            echo "VERSION=${GITHUB_RUN_NUMBER}" >> $GITHUB_ENV
          elif [ "${GITHUB_EVENT_NAME}" = "pull_request" ]; then
            echo "VERSION=${ISSUE_NUMBER}" >> $GITHUB_ENV
          fi
      - name: Launch build and publish script
        run: |
          if [ "${GITHUB_REF##*/}" = "master" ] ;then
            orc8r/tools/helm/package.sh --deployment-type all --version $VERSION  --only-package
          elif [ "${GITHUB_EVENT_NAME}" = "pull_request" ] ;then
            mkdir -p charts
            orc8r/tools/helm/package.sh --deployment-type all --version $VERSION --only-package
          else
            orc8r/tools/helm/package.sh --deployment-type all
          fi
      - name: Upload charts as artifacts
        uses: actions/upload-artifact@3cea5372237819ed00197afe530f5a7ea3e805c8 # pin@v3
        if: github.event_name == 'pull_request'
        with:
          name: helm-charts
          path: charts
      # Need to save PR number as Github action does not propagate it with workflow_run event
      # Used as version for PR builds
      - name: Save PR number
        run: |
          mkdir -p ./pr
          echo ${{ github.event.number }} > ./pr/pr_number
          echo "false" > ./pr/skipped
      - uses: actions/upload-artifact@3cea5372237819ed00197afe530f5a7ea3e805c8 # pin@v3
        with:
          name: pr
          path: pr/
      # Notify ci channel when failing
      # Plugin info: https://github.com/marketplace/actions/slack-notify
      - name: Notify failure to slack
        if: failure() && github.event_name == 'push'
        uses: rtCamp/action-slack-notify@12e36fc18b0689399306c2e0b3e0f2978b7f1ee7 # pin@v2.2.0
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_CI }}
          SLACK_TITLE: "Github action Push helm charts to artifactory failed"
          SLACK_MESSAGE: ${{ github.event.head_commit.message || github.event.pull_request.title }}
          SLACK_USERNAME: ${{ github.workflow }}
          SLACK_ICON_EMOJI: ":boom:"
          SLACK_COLOR: "#FF0000"
          SLACK_FOOTER: ' '
      # Notify ci channel when push succeeds
      - name: Notify success to Slack
        if: success() && github.event_name == 'push'
        uses: rtCamp/action-slack-notify@12e36fc18b0689399306c2e0b3e0f2978b7f1ee7 # pin@v2.2.0
        env:
          SLACK_CHANNEL: ${{ secrets.SLACK_CHANNEL_ARTIFACTS }}
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_OSS }}
          SLACK_TITLE: "*Helm charts have been published*"
          SLACK_MESSAGE: ${{ github.event.head_commit.message || github.event.pull_request.title }}
          SLACK_USERNAME: ${{ github.workflow }}
          SLACK_ICON_EMOJI: ":heavy_check_mark:"
          SLACK_COLOR: "#00FF00"
          SLACK_FOOTER: ' '
      - name: Only keep the last 20 uploaded versions
        if: github.event_name == 'push'
        run: |
          pip install artifactory
          python ci-scripts/helm_repo_rotation.py
  agw-build:
    if: github.event_name == 'push' && github.repository_owner == 'magma'
    runs-on: macos-12
    outputs:
      artifacts: ${{ steps.publish_packages.outputs.artifacts }}
      magma_package: ${{ steps.publish_packages.outputs.magma_package }}
    steps:
      - uses: actions/checkout@93ea575cb5d8a053eaa0ac8fa3b40d7e05a33cc8 # pin@v3.1.0
        with:
          fetch-depth: 0
      - name: Cache magma-dev-box
        uses: actions/cache@9b0c1fce7a93df8e3bb8926b0d6e9d89e92f20a7 # pin@v3.0.11
        with:
          path: ~/.vagrant.d/boxes/magmacore-VAGRANTSLASH-magma_dev
          key: vagrant-box-magma-dev-v1.2.20221012
      - name: Log in to vagrant cloud
        run: |
          if [[ -n "${{ secrets.VAGRANT_TOKEN }}" ]]
          then
            echo "Logging in to vagrant cloud to mitigate rate limiting."
            vagrant cloud auth login --token "${{ secrets.VAGRANT_TOKEN }}"
          else
            echo "Vagrant cloud token is not configured. Skipping login."
          fi
      - uses: actions/setup-python@13ae5bb136fac2878aff31522b9efb785519f984 # pin@v4.3.0
        with:
          python-version: '3.8.10'
      - name: Install pre requisites
        run: |
          pip3 install --upgrade pip
          pip3 install ansible fabric3 jsonpickle requests PyYAML
          vagrant plugin install vagrant-disksize vagrant-vbguest vagrant-mutate vagrant-reload
      - name: Open up network interfaces for VM
        run: |
          sudo mkdir -p /etc/vbox/
          sudo touch /etc/vbox/networks.conf
          sudo sh -c "echo '* 192.168.0.0/16' > /etc/vbox/networks.conf"
          sudo sh -c "echo '* 3001::/64' >> /etc/vbox/networks.conf"
      - name: Build AGW
        run: |
          export MAGMA_DEV_MEMORY_MB=4096
          cd lte/gateway
          fab release package:destroy_vm=True
          mkdir magma-packages
          vagrant ssh -c "cp -r magma-packages /vagrant"
      - name: Setup JFROG CLI
        uses: jfrog/setup-jfrog-cli@d0a59b1cdaeeb16e65b5039fc92b8507337f1559 # pin@v3
      - name: Publish debian packages
        id: publish_packages
        if: github.event_name == 'push'
        env:
          DEBIAN_META_INFO: deb.distribution=focal-ci;deb.component=main;deb.architecture=amd64
        run: |
          # Default firebase output before anything can fail
          ARTIFACTS='{"packages":[],"valid":false}'
          echo "artifacts=$(echo $ARTIFACTS)" >> $GITHUB_OUTPUT

          set -euo pipefail

          cd lte/gateway/magma-packages

          # Extract magma debian package version
          version_pattern="magma_([0-9]+\.[0-9]+\.[0-9]+-[0-9]+-[a-z0-9]+)_amd64.deb"
          magma_version=""
          for i in *.deb; do
              if [[ $i =~ $version_pattern ]]; then
                  magma_version=${BASH_REMATCH[1]}
              fi
          done
          if [[ -z "$magma_version" ]]; then
              echo "No file found with a matching version pattern \"${version_pattern}\". Files in folder:"
              ls -la
              exit 1
          else
              echo "Exporting magma version \"${magma_version}\""
              echo "magma_package=magma=${magma_version}" >> $GITHUB_OUTPUT
          fi

          # Uploading packages to the registry
          RESPONSE=$(jf rt upload \
            --recursive=false \
            --detailed-summary \
            --url https://linuxfoundation.jfrog.io/artifactory/ \
            --user ${{ secrets.LF_JFROG_USERNAME }} \
            --password ${{ secrets.LF_JFROG_PASSWORD }} \
            --target-props="${DEBIAN_META_INFO}" \
            "(*).deb" magma-packages-test/pool/focal-ci/{1}.deb)

          # Mapping response to output (for firebase)
          echo "Response:"
          echo $RESPONSE | jq
          echo "Output (for firebase):"
          ARTIFACTS=$(echo $RESPONSE | jq '{"valid": (.status=="success"), "packages": [.files[] | .target]}')
          echo $ARTIFACTS | jq
          echo "artifacts=$(echo $ARTIFACTS)" >> $GITHUB_OUTPUT
      - uses: actions/upload-artifact@3cea5372237819ed00197afe530f5a7ea3e805c8 # pin@v3
        if: github.event_name == 'pull_request'
        with:
          name: magma-packages
          path: lte/gateway/magma-packages/*.deb
      - name: Notify failure to slack
        if: failure() && github.event_name == 'push'
        env:
          SLACK_TITLE: "Github action agw build failed"
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
          SLACK_USERNAME: ${{ github.workflow }}
          SLACK_AVATAR: ":boom:"
        uses: Ilshidur/action-slack@689ad44a9c9092315abd286d0e3a9a74d31ab78a # pin@2.1.0
        with:
          args: "AGW  build failed in run <https://github.com/${{github.repository}}/actions/runs/${{github.run_id}}|${{github.run_id}}> from commit ${{ github.sha }}: ${{ github.event.head_commit.message || github.event.pull_request.title }}"
      # Notify ci channel when push succeeds
      - name: Notify success to Slack
        if: success() && github.event_name == 'push'
        env:
          SLACK_TITLE: "Github action agw build got published"
          SLACK_CHANNEL: ${{ secrets.SLACK_CHANNEL_ARTIFACTS }}
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_OSS }}
          SLACK_USERNAME: ${{ github.workflow }}
        uses: Ilshidur/action-slack@689ad44a9c9092315abd286d0e3a9a74d31ab78a # pin@2.1.0
        with:
          args: "AGW build succeeded in run <https://github.com/${{github.repository}}/actions/runs/${{github.run_id}}|${{github.run_id}}> from commit ${{ github.sha }}: ${{ github.event.head_commit.message || github.event.pull_request.title }}"

  orc8r-build:
    if: github.repository_owner == 'magma'
    name: orc8r build job
    runs-on: ubuntu-20.04
    outputs:
      artifacts: ${{ steps.publish_artifacts.outputs.artifacts }}
    env:
      MAGMA_ROOT: "${{ github.workspace }}"
    steps:
      - uses: actions/checkout@93ea575cb5d8a053eaa0ac8fa3b40d7e05a33cc8 # pin@v3.1.0
      - name: Run apt-get update
        run: sudo apt-get update
      - uses: actions/setup-python@13ae5bb136fac2878aff31522b9efb785519f984 # pin@v4.3.0
        with:
          python-version: '3.8.10'
      - name: Run build.py
        run: |
          cd ${MAGMA_ROOT}/orc8r/cloud/docker
          python3 build.py --all --nocache --parallel
      - name: Export docker images to deploy them
        if: github.event_name == 'pull_request'
        run: |
          mkdir images
          cd images
          docker save orc8r_nginx | gzip > nginx.tar.gz
          docker save orc8r_controller  | gzip > controller.tar.gz
      - uses: actions/upload-artifact@3cea5372237819ed00197afe530f5a7ea3e805c8 # pin@v3
        if: github.event_name == 'pull_request'
        with:
          name: docker-images-orc8r
          path: images
      - name: Create release Tag
        if: github.event_name == 'push'
        run: |
          if [ "$GITHUB_REF" = "refs/heads/master" ]; then
            echo TAG="${GITHUB_SHA:0:8}" >> $GITHUB_ENV
          else
            GIT_BRANCH_VERSION=${GITHUB_BASE_REF:-${GITHUB_REF#refs/heads/}}
            echo TAG="${GIT_BRANCH_VERSION:1}" >> $GITHUB_ENV
          fi
      - name: Tag and push to Jfrog Registry
        id: publish_artifacts
        if: github.event_name == 'push'
        env:
          DOCKER_REGISTRY: "linuxfoundation.jfrog.io/magma-docker-orc8r-test"
          DOCKER_USER: "${{ secrets.LF_JFROG_USERNAME }}"
          DOCKER_PASSWORD: "${{ secrets.LF_JFROG_PASSWORD }}"
        run: |
          ./ci-scripts/tag-push-docker.sh --images 'nginx|controller' --tag "${TAG}" --tag-latest true --project orc8r
          ARTIFACTS="{\"packages\":[\"$DOCKER_REGISTRY/nginx:${TAG}\", \"$DOCKER_REGISTRY/controller:${TAG}\"],\"valid\":true}"
          echo "artifacts=$(echo $ARTIFACTS)" >> $GITHUB_OUTPUT
      - name: Notify failure to Slack
        if: failure() && github.event_name == 'push'
        uses: rtCamp/action-slack-notify@12e36fc18b0689399306c2e0b3e0f2978b7f1ee7 # pin@v2.2.0
        # yamllint enable
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
          SLACK_TITLE: "Github action orc8r-build failed"
          SLACK_USERNAME: ${{ github.workflow }}
          SLACK_MESSAGE: ${{ github.event.head_commit.message || github.event.pull_request.title }}
          SLACK_ICON_EMOJI: ":boom:"
          SLACK_COLOR: "#FF0000"
          SLACK_FOOTER: ' '
      # Notify ci channel when push succeeds
      - name: Notify success to Slack
        if: success() && github.event_name == 'push'
        uses: rtCamp/action-slack-notify@12e36fc18b0689399306c2e0b3e0f2978b7f1ee7 # pin@v2.2.0
        env:
          SLACK_CHANNEL: ${{ secrets.SLACK_CHANNEL_ARTIFACTS }}
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_OSS }}
          SLACK_TITLE: "*Orchestrator images have been published*"
          SLACK_MESSAGE: ${{ github.event.head_commit.message || github.event.pull_request.title }}
          SLACK_USERNAME: ${{ github.workflow }}
          SLACK_ICON_EMOJI: ":heavy_check_mark:"
          SLACK_COLOR: "#00FF00"
          SLACK_FOOTER: ' '

  cloud-upload:
    name: cloud upload job
    runs-on: ubuntu-20.04
    if: github.event_name == 'push' && github.repository_owner == 'magma'
    steps:
      - uses: actions/checkout@93ea575cb5d8a053eaa0ac8fa3b40d7e05a33cc8 # pin@v3.1.0
      - name: Install SwaggerHub CLI
        run: npm install --global swaggerhub-cli
      - name: Publish SwaggerHub API
        env:
          MAGMA_ROOT: "${{ github.workspace }}"
          SWAGGERHUB_API_KEY: "${{ secrets.SWAGGERHUB_API_KEY }}"
        run: |
          swaggerhub api:unpublish MagmaCore/Magma/1.0.0
          swaggerhub api:update MagmaCore/Magma/1.0.0 --file ${MAGMA_ROOT}/orc8r/cloud/go/services/obsidian/swagger/v1/swagger.yml --published=publish --visibility=public --setdefault
      - name: Notify failure to Slack
        if: failure() && github.event_name == 'push'
        uses: rtCamp/action-slack-notify@12e36fc18b0689399306c2e0b3e0f2978b7f1ee7 # pin@v2.2.0
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_CI }}
          SLACK_TITLE: "Github action cloud-upload failed"
          SLACK_MESSAGE: ${{ github.event.head_commit.message || github.event.pull_request.title }}
          SLACK_USERNAME: ${{ github.workflow }}
          SLACK_ICON_EMOJI: ":boom:"
          SLACK_COLOR: "#FF0000"
          SLACK_FOOTER: ' '
      # Notify ci channel when push succeeds
      - name: Notify success to Slack
        if: success() && github.event_name == 'push'
        uses: rtCamp/action-slack-notify@12e36fc18b0689399306c2e0b3e0f2978b7f1ee7 # pin@v2.2.0
        env:
          SLACK_CHANNEL: ${{ secrets.SLACK_CHANNEL_ARTIFACTS }}
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_OSS }}
          SLACK_TITLE: "*SwaggerHub Updated*"
          SLACK_MESSAGE: ${{ github.event.head_commit.message || github.event.pull_request.title }}
          SLACK_USERNAME: ${{ github.workflow }}
          SLACK_ICON_EMOJI: ":heavy_check_mark:"
          SLACK_COLOR: "#00FF00"
          SLACK_FOOTER: ' '
  cwag-deploy:
    if: github.repository_owner == 'magma'
    name: cwag deploy job
    runs-on: ubuntu-20.04
    outputs:
      artifacts: ${{ steps.publish_artifacts.outputs.artifacts }}
    env:
      MAGMA_ROOT: "${{ github.workspace }}"
    steps:
      - uses: actions/checkout@93ea575cb5d8a053eaa0ac8fa3b40d7e05a33cc8 # pin@v3.1.0
      - name: Run docker compose
        id: cwag-docker-compose
        continue-on-error: true
        # yamllint disable rule:line-length
        env:
          DOCKER_REGISTRY: cwf_
        run: |
          cd ${MAGMA_ROOT}/cwf/gateway/docker
          docker-compose --file docker-compose.yml --file docker-compose.override.yml build --parallel
      - name: Retry docker compose on failure
        id: retry-cwag-docker-compose
        continue-on-error: true
        if: steps.cwag-docker-compose.outcome=='failure'
        env:
          DOCKER_REGISTRY: cwf_
        run: |
          cd ${MAGMA_ROOT}/cwf/gateway/docker
          docker-compose --file docker-compose.yml --file docker-compose.override.yml build --parallel
      - name: Set the job status
        if: always()
        run: |
          if ${{ steps.cwag-docker-compose.outcome=='success' || steps.retry-cwag-docker-compose.outcome=='success' }}; then
             echo "Docker compose completed successfully"
          else
             echo "Docker compose failed"
             exit 1
          fi
      - name: Export docker images to deploy them on pull_request
        if: github.event_name == 'pull_request'
        run: |
          mkdir images
          cd images
          docker save cwf_cwag_go | gzip > cwag_go.tar.gz
          docker save cwf_gateway_go | gzip > gateway_go.tar.gz
          docker save cwf_gateway_sessiond | gzip > gateway_sessiond.tar.gz
          docker save cwf_gateway_python | gzip > gateway_python.tar.gz
          docker save cwf_gateway_pipelined | gzip > gateway_pipelined.tar.gz
      - name: Upload docker images as artifacts
        uses: actions/upload-artifact@3cea5372237819ed00197afe530f5a7ea3e805c8 # pin@v3
        if: github.event_name == 'pull_request'
        with:
          name: docker-images-cwag
          path: images
      # Need to save PR number as Github action does not propagate it with workflow_run event
      # Used as version for PR builds
      - name: Save PR number
        run: |
          mkdir -p ./pr
          echo ${{ github.event.number }} > ./pr/pr_number
      - uses: actions/upload-artifact@3cea5372237819ed00197afe530f5a7ea3e805c8 # pin@v3
        with:
          name: pr
          path: pr/
      - name: Create release Tag
        if: github.event_name == 'push'
        run: |
          if [ "$GITHUB_REF" = "refs/heads/master" ]; then
            echo TAG="${GITHUB_SHA:0:8}" >> $GITHUB_ENV
          else
            GIT_BRANCH_VERSION=${GITHUB_BASE_REF:-${GITHUB_REF#refs/heads/}}
            echo TAG="${GIT_BRANCH_VERSION:1}" >> $GITHUB_ENV
          fi
      - name: Tag and push to Jfrog Registry
        id: publish_artifacts
        if: github.event_name == 'push'
        env:
          DOCKER_REGISTRY: "linuxfoundation.jfrog.io/magma-docker-cwag-test"
          DOCKER_USER: "${{ secrets.LF_JFROG_USERNAME }}"
          DOCKER_PASSWORD: "${{ secrets.LF_JFROG_PASSWORD }}"
        run: |
          ./ci-scripts/tag-push-docker.sh --images 'cwag_go|gateway_go|gateway_python|gateway_sessiond|gateway_pipelined' --tag "${TAG}" --tag-latest true --project cwf
          ARTIFACTS="{\"packages\":[\"$DOCKER_REGISTRY/cwag_go:${TAG}\", \"$DOCKER_REGISTRY/gateway_go:${TAG}\", \"$DOCKER_REGISTRY/gateway_python:${TAG}\", \"$DOCKER_REGISTRY/gateway_sessiond:${TAG}\",\"$DOCKER_REGISTRY/gateway_pipelined:${TAG}\"],\"valid\":true}"
          echo "artifacts=$(echo $ARTIFACTS)" >> $GITHUB_OUTPUT
      # Notify ci channel when failing
      # Plugin info: https://github.com/marketplace/actions/slack-notify
      # yamllint enable
      - name: Notify failure to slack
        if: failure() && github.event_name == 'push'
        uses: rtCamp/action-slack-notify@12e36fc18b0689399306c2e0b3e0f2978b7f1ee7 # pin@v2.2.0
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_CI }}
          SLACK_TITLE: "CWAG-deploy failed"
          SLACK_MESSAGE: ${{ github.event.head_commit.message || github.event.pull_request.title }}
          SLACK_USERNAME: ${{ github.workflow }}
          SLACK_ICON_EMOJI: ":boom:"
          SLACK_COLOR: "#FF0000"
          SLACK_FOOTER: ' '
      # Notify ci channel when push succeeds
      - name: Notify success to slack
        if: success() && github.event_name == 'push'
        uses: rtCamp/action-slack-notify@12e36fc18b0689399306c2e0b3e0f2978b7f1ee7 # pin@v2.2.0
        env:
          SLACK_CHANNEL: ${{ secrets.SLACK_CHANNEL_ARTIFACTS }}
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_OSS }}
          SLACK_TITLE: "*CWAG Artifact Has Been Published*"
          SLACK_MESSAGE: ${{ github.event.head_commit.message || github.event.pull_request.title }}
          SLACK_USERNAME: ${{ github.workflow }}
          SLACK_ICON_EMOJI: ":heavy_check_mark:"
          SLACK_COLOR: "#00FF00"
          SLACK_FOOTER: ' '
  cwf-operator-build:
    if: github.repository_owner == 'magma'
    name: cwf operator build job
    runs-on: ubuntu-20.04
    env:
      MAGMA_ROOT: "${{ github.workspace }}"
    steps:
      - uses: actions/checkout@93ea575cb5d8a053eaa0ac8fa3b40d7e05a33cc8 # pin@v3.1.0
      - name: Run docker compose build
        env:
          DOCKER_REGISTRY: cwf_
        run: |
          cd ${MAGMA_ROOT}/cwf/k8s/cwf_operator/docker
          DOCKER_REGISTRY=cwf_ docker-compose build --parallel
      - name: Export docker images to deploy them on pull_request
        if: github.event_name == 'pull_request'
        run: |
          mkdir images
          cd images
          docker save cwf_operator | gzip > operator.tar.gz
      - name: Upload docker images as artifacts
        uses: actions/upload-artifact@3cea5372237819ed00197afe530f5a7ea3e805c8 # pin@v3
        if: github.event_name == 'pull_request'
        with:
          name: docker-images-cwf
          path: images
      # Need to save PR number as Github action does not propagate it with workflow_run event
      # Used as version for PR builds
      - name: Save PR number
        run: |
          mkdir -p ./pr
          echo ${{ github.event.number }} > ./pr/pr_number
      - uses: actions/upload-artifact@3cea5372237819ed00197afe530f5a7ea3e805c8 # pin@v3
        with:
          name: pr
          path: pr/
      - name: Create release Tag
        if: github.event_name == 'push'
        run: |
          if [ "$GITHUB_REF" = "refs/heads/master" ]; then
            echo TAG="${GITHUB_SHA:0:8}" >> $GITHUB_ENV
          else
            GIT_BRANCH_VERSION=${GITHUB_BASE_REF:-${GITHUB_REF#refs/heads/}}
            echo TAG="${GIT_BRANCH_VERSION:1}" >> $GITHUB_ENV
          fi
      - name: Tag and push to Jfrog Registry
        id: publish_artifacts
        if: github.event_name == 'push'
        env:
          DOCKER_REGISTRY: "linuxfoundation.jfrog.io/magma-docker-cwag-test"
          DOCKER_USER: "${{ secrets.LF_JFROG_USERNAME }}"
          DOCKER_PASSWORD: "${{ secrets.LF_JFROG_PASSWORD }}"
        run: |
          ./ci-scripts/tag-push-docker.sh --images 'operator' --tag "${TAG}" --tag-latest true --project cwf
      # Notify ci channel when failing
      # Plugin info: https://github.com/marketplace/actions/slack-notify
      # yamllint enable
      - name: Notify failure to slack
        if: failure() && github.ref == 'refs/heads/master'
        uses: rtCamp/action-slack-notify@12e36fc18b0689399306c2e0b3e0f2978b7f1ee7 # pin@v2.2.0
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_CI }}
          SLACK_TITLE: "CWF-operator-build failed"
          SLACK_MESSAGE: ${{ github.event.head_commit.message || github.event.pull_request.title }}
          SLACK_USERNAME: ${{ github.workflow }}
          SLACK_ICON_EMOJI: ":boom:"
          SLACK_COLOR: "#FF0000"
          SLACK_FOOTER: ''
      # Notify ci channel when push succeeds
      - name: Notify success to slack
        if: success() && github.ref == 'refs/heads/master'
        uses: rtCamp/action-slack-notify@12e36fc18b0689399306c2e0b3e0f2978b7f1ee7 # pin@v2.2.0
        env:
          SLACK_CHANNEL: ${{ secrets.SLACK_CHANNEL_ARTIFACTS }}
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_OSS }}
          SLACK_MESSAGE: ${{ github.event.head_commit.message || github.event.pull_request.title }}
          SLACK_TITLE: "*CWF Artifact Has Been Published*"
          SLACK_USERNAME: ${{ github.workflow }}
          SLACK_ICON_EMOJI: ":heavy_check_mark:"
          SLACK_COLOR: "#00FF00"
          SLACK_FOOTER: ''
  feg-build:
    if: github.repository_owner == 'magma'
    name: feg-build
    runs-on: ubuntu-20.04
    outputs:
      artifacts: ${{ steps.publish_artifacts.outputs.artifacts }}
    env:
      MAGMA_ROOT: "${{ github.workspace }}"
    steps:
      - uses: actions/checkout@93ea575cb5d8a053eaa0ac8fa3b40d7e05a33cc8 # pin@v3.1.0
      - uses: actions/setup-python@13ae5bb136fac2878aff31522b9efb785519f984 # pin@v4.3.0
        with:
          python-version: '3.8.10'
      - name: generate test certs and snowflake
        run: |
          # TODO add rootCA.pem and snowflake files in the ubuntu-1604:201903-01 image
          # create directories
          cd ${MAGMA_ROOT} && mkdir -p .cache/test_certs/ && mkdir -p .cache/feg/
          # create test certs
          cd ${MAGMA_ROOT}/.cache/test_certs/
          openssl genrsa -out rootCA.key 2048
          openssl req -x509 -new -nodes -key rootCA.key -sha256 -days 365000 -out rootCA.pem -subj "/C=US/CN=rootca.magma.test"
          # create snowflake
          cd ${MAGMA_ROOT}/.cache/feg/ && touch snowflake
      - name: Build docker images
        env:
          DOCKER_REGISTRY: feg_
        run: |
          cd ${MAGMA_ROOT}/feg/gateway/docker
          python3 build.py
      - name: run docker containers and check health
        env:
          DOCKER_REGISTRY: feg_
        run: |
          cd ${MAGMA_ROOT}/feg/gateway/docker
          python3 build.py -e
      - name: Export docker images to deploy them on pull_request
        if: github.event_name == 'pull_request'
        run: |
          mkdir images
          cd images
          docker save feg_gateway_go | gzip > feg_gateway_go.tar.gz
          docker save feg_gateway_python | gzip > feg_gateway_python.tar.gz
      - name: Upload docker images as artifacts
        uses: actions/upload-artifact@3cea5372237819ed00197afe530f5a7ea3e805c8 # pin@v3
        if: github.event_name == 'pull_request'
        with:
          name: docker-images-feg
          path: images
      - name: Create release Tag
        run: |
          if [ "$GITHUB_REF" = "refs/heads/master" ]; then
            echo TAG="${GITHUB_SHA:0:8}" >> $GITHUB_ENV
          else
            GIT_BRANCH_VERSION=${GITHUB_BASE_REF:-${GITHUB_REF#refs/heads/}}
            echo TAG="${GIT_BRANCH_VERSION:1}" >> $GITHUB_ENV
          fi
      - name: Tag and push to Jfrog Registry
        id: publish_artifacts
        if: github.event_name == 'push'
        env:
          DOCKER_REGISTRY: "linuxfoundation.jfrog.io/magma-docker-feg-test"
          DOCKER_USER: "${{ secrets.LF_JFROG_USERNAME }}"
          DOCKER_PASSWORD: "${{ secrets.LF_JFROG_PASSWORD }}"
        run: |
          ./ci-scripts/tag-push-docker.sh --images 'gateway_go|gateway_python' --tag "${TAG}" --tag-latest true --project feg
          ARTIFACTS="{\"packages\":[\"$DOCKER_REGISTRY/gateway_go:${TAG}\", \"$DOCKER_REGISTRY/gateway_python:${TAG}\"],\"valid\":true}"
          echo "artifacts=$(echo $ARTIFACTS)" >> $GITHUB_OUTPUT
      # Notify ci channel when failing
      # Plugin info: https://github.com/marketplace/actions/slack-notify
      # yamllint enable
      - name: Notify failure to slack
        if: failure() && github.event_name == 'push'
        uses: rtCamp/action-slack-notify@12e36fc18b0689399306c2e0b3e0f2978b7f1ee7 # pin@v2.2.0
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_CI }}
          SLACK_TITLE: "FeG-precommit tests failed"
          SLACK_MESSAGE: ${{ github.event.head_commit.message || github.event.pull_request.title }}
          SLACK_USERNAME: ${{ github.workflow }}
          SLACK_ICON_EMOJI: ":boom:"
          SLACK_COLOR: "#FF0000"
          SLACK_FOOTER: ' '
      # Notify ci channel when push succeeds
      - name: Notify success to slack
        if: success() && github.event_name == 'push'
        uses: rtCamp/action-slack-notify@12e36fc18b0689399306c2e0b3e0f2978b7f1ee7 # pin@v2.2.0
        env:
          SLACK_CHANNEL: ${{ secrets.SLACK_CHANNEL_ARTIFACTS }}
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_OSS }}
          SLACK_TITLE: "*FeG Artifact Has Been Published*"
          SLACK_MESSAGE: ${{ github.event.head_commit.message || github.event.pull_request.title }}
          SLACK_USERNAME: ${{ github.workflow }}
          SLACK_ICON_EMOJI: ":heavy_check_mark:"
          SLACK_COLOR: "#00FF00"
          SLACK_FOOTER: ' '
  nms-build:
    if: github.repository_owner == 'magma'
    name: nms-build job
    runs-on: ubuntu-20.04
    outputs:
      artifacts: ${{ steps.publish_artifacts.outputs.artifacts }}
    env:
      MAGMA_ROOT: "${{ github.workspace }}"
      NMS_ROOT: "${{ github.workspace }}/nms"
    steps:
      - uses: actions/checkout@93ea575cb5d8a053eaa0ac8fa3b40d7e05a33cc8 # pin@v3.1.0
      - name: Run docker compose
        id: nms-docker-compose
        # yamllint disable rule:line-length
        run: |
          cd ${MAGMA_ROOT}/nms
          COMPOSE_PROJECT_NAME=magmalte docker-compose build magmalte
      - name: Export docker images to deploy them on pull_request
        if: github.event_name == 'pull_request'
        run: |
          mkdir images
          cd images
          docker save magmalte_magmalte | gzip > magmalte.tar.gz
      - name: Upload docker images as artifacts
        uses: actions/upload-artifact@3cea5372237819ed00197afe530f5a7ea3e805c8 # pin@v3
        if: github.event_name == 'pull_request'
        with:
          name: docker-images-nms
          path: images
      - name: Create release Tag
        if: github.event_name == 'push'
        run: |
          if [ "$GITHUB_REF" = "refs/heads/master" ]; then
            echo TAG="${GITHUB_SHA:0:8}" >> $GITHUB_ENV
          else
            GIT_BRANCH_VERSION=${GITHUB_BASE_REF:-${GITHUB_REF#refs/heads/}}
            echo TAG="${GIT_BRANCH_VERSION:1}" >> $GITHUB_ENV
          fi
      - name: Tag and push to Jfrog Registry
        id: publish_artifacts
        if: github.event_name == 'push'
        env:
          DOCKER_REGISTRY: "linuxfoundation.jfrog.io/magma-docker-orc8r-test"
          DOCKER_USER: "${{ secrets.LF_JFROG_USERNAME }}"
          DOCKER_PASSWORD: "${{ secrets.LF_JFROG_PASSWORD }}"
        run: |
          ./ci-scripts/tag-push-docker.sh --images 'magmalte' --tag "${TAG}" --tag-latest true --project magmalte
          ARTIFACTS="{\"packages\":[\"$DOCKER_REGISTRY/magmalte:${TAG}\"],\"valid\":true}"
          echo "artifacts=$(echo $ARTIFACTS)" >> $GITHUB_OUTPUT
      # Notify ci channel when failing
      # Plugin info: https://github.com/marketplace/actions/slack-notify
      # yamllint enable
      - name: Notify failure to slack
        if: failure() && github.event_name == 'push'
        uses: rtCamp/action-slack-notify@12e36fc18b0689399306c2e0b3e0f2978b7f1ee7 # pin@v2.2.0
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
          SLACK_TITLE: "Github action nms-build failed"
          SLACK_MESSAGE: ${{ github.event.head_commit.message || github.event.pull_request.title }}
          SLACK_USERNAME: ${{ github.workflow }}
          SLACK_ICON_EMOJI: ":boom:"
          SLACK_COLOR: "#FF0000"
          SLACK_FOOTER: ' '
      # Notify ci channel when push succeeds
      - name: Notify success to slack
        if: success() && github.event_name == 'push'
        uses: rtCamp/action-slack-notify@12e36fc18b0689399306c2e0b3e0f2978b7f1ee7 # pin@v2.2.0
        env:
          SLACK_CHANNEL: ${{ secrets.SLACK_CHANNEL_ARTIFACTS }}
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_OSS }}
          SLACK_TITLE: "NMS Artifact Has Been Published*"
          SLACK_MESSAGE: ${{ github.event.head_commit.message || github.event.pull_request.title }}
          SLACK_USERNAME: ${{ github.workflow }}
          SLACK_ICON_EMOJI: ":heavy_check_mark:"
          SLACK_COLOR: "#00FF00"
          SLACK_FOOTER: ' '
  Publish_to_firebase:
    name: Publish to firebase
    if: always() && github.event_name == 'push' && github.repository_owner == 'magma'
    runs-on: ubuntu-20.04
    needs:
      [
        agw-build,
        feg-build,
        orc8r-build,
        cwag-deploy,
        nms-build
      ]
    steps:
      - uses: actions/checkout@93ea575cb5d8a053eaa0ac8fa3b40d7e05a33cc8 # pin@v3.1.0
      - uses: actions/setup-python@13ae5bb136fac2878aff31522b9efb785519f984 # pin@v4.3.0
        with:
          python-version: '3.8.10'
      - name: Publish to
        env:
          FIREBASE_CONFIG: ${{ secrets.FIREBASE_CONFIG }}
          WORKERS: "wl_lab_5g,feg_integ_test" # all workers for post-merge pipeline. Comma separated
          BUILD_ID: "${{ github.sha }}"
          BUILD_METADATA: '{"github:workflow": "${{ github.workflow }}", "github:run_id": "${{ github.run_id }}", "github:actor": "${{ github.actor }}", "github:repository": "${{ github.repository }}",
            "github:event_name": "${{ github.event_name }}", "github:sha": "${{ github.sha }}", "github:sha:url": "${{github.event.repository.owner.html_url}}/magma/commit/${{github.sha}}",
            "github:ref": "${{ github.ref }}"}'
          AGW_ARTIFACTS: ${{ needs.agw-build.outputs.artifacts }}
          FEG_ARTIFACTS: ${{ needs.feg-build.outputs.artifacts }}
          ORC8R_ARTIFACTS: ${{ needs.orc8r-build.outputs.artifacts }}
          CWAG_ARTIFACTS: ${{ needs.cwag-deploy.outputs.artifacts }}
          NMS_ARTIFACTS: ${{ needs.nms-build.outputs.artifacts }}
        run: |
          python -m pip install --upgrade pip
          pip install Pyrebase
          python ci-scripts/firebase_publish.py
  domain-proxy-build:
    if: github.repository_owner == 'magma'
    name: domain proxy build job
    runs-on: ubuntu-20.04
    outputs:
      artifacts: ${{ steps.publish_artifacts.outputs.artifacts }}
    env:
      MAGMA_ROOT: "${{ github.workspace }}"
    steps:
      - uses: actions/checkout@93ea575cb5d8a053eaa0ac8fa3b40d7e05a33cc8 # pin@v3.1.0
      - name: Prepare tools
        working-directory: "${{ github.workspace }}/dp"
        run: |
          make _install_skaffold_ci
      - name: Create release Tag
        if: github.event_name == 'push'
        run: |
          if [ "$GITHUB_REF" = "refs/heads/master" ]; then
            echo TAG="${GITHUB_SHA:0:8}" >> $GITHUB_ENV
          else
            GIT_BRANCH_VERSION=${GITHUB_BASE_REF:-${GITHUB_REF#refs/heads/}}
            echo TAG="${GIT_BRANCH_VERSION:1}" >> $GITHUB_ENV
          fi
      - name: Tag and push to Jfrog Registry
        id: publish_artifacts
        if: github.event_name == 'push'
        working-directory: "${{ github.workspace }}/dp"
        env:
          DOCKER_REGISTRY: "linuxfoundation.jfrog.io/magma-docker-orc8r-test"
          DOCKER_USER: "${{ secrets.LF_JFROG_USERNAME }}"
          DOCKER_PASSWORD: "${{ secrets.LF_JFROG_PASSWORD }}"
        run: |
          docker login "${DOCKER_REGISTRY}" -u "${DOCKER_USER}" -p "${DOCKER_PASSWORD}"
          skaffold build --default-repo="${DOCKER_REGISTRY}" --tag="${TAG}" --push --profile=remote-push
      - name: Notify failure to Slack
        if: failure() && github.event_name == 'push'
        uses: rtCamp/action-slack-notify@12e36fc18b0689399306c2e0b3e0f2978b7f1ee7 # pin@v2.2.0
        # yamllint enable
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
          SLACK_TITLE: "Github action domain-proxy-build failed"
          SLACK_USERNAME: ${{ github.workflow }}
          SLACK_MESSAGE: ${{ github.event.head_commit.message || github.event.pull_request.title }}
          SLACK_ICON_EMOJI: ":boom:"
          SLACK_COLOR: "#FF0000"
          SLACK_FOOTER: ' '
      # Notify ci channel when push succeeds
      - name: Notify success to Slack
        if: success() && github.event_name == 'push'
        uses: rtCamp/action-slack-notify@12e36fc18b0689399306c2e0b3e0f2978b7f1ee7 # pin@v2.2.0
        env:
          SLACK_CHANNEL: ${{ secrets.SLACK_CHANNEL_ARTIFACTS }}
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_OSS }}
          SLACK_TITLE: "*Domain proxy images have been published*"
          SLACK_MESSAGE: ${{ github.event.head_commit.message || github.event.pull_request.title }}
          SLACK_USERNAME: ${{ github.workflow }}
          SLACK_ICON_EMOJI: ":heavy_check_mark:"
          SLACK_COLOR: "#00FF00"
          SLACK_FOOTER: ' '
  trigger-debian-integ-test:
    if: always() && github.event_name == 'push' && github.repository_owner == 'magma' && github.ref == 'refs/heads/master'
    runs-on: ubuntu-20.04
    needs: agw-build
    steps:
      - name: Trigger debian integ test workflow
        uses: peter-evans/repository-dispatch@f2696244ec00ed5c659a5cc77f7138ad0302dffb # pin@v2.1.0
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          repository: magma/magma
          event-type: build-all-artifact
          client-payload: '{ "artifact": "${{ needs.agw-build.outputs.magma_package }}", "trigger_sha": "${{ github.sha }}" }'
