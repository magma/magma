apiVersion: skaffold/v2beta16
kind: Config
metadata:
  name: domain-proxy
build:
  tagPolicy:
    sha256: {}
  local:
    push: false
    concurrency: 0
  artifacts:
    - image: active-mode-controller
      context: ..
      docker:
        dockerfile: dp/cloud/docker/go/active_mode_controller/Dockerfile
    - image: protocol-controller
      context: ..
      docker:
        dockerfile: dp/cloud/docker/python/protocol_controller/Dockerfile
    - image: configuration-controller
      context: ..
      docker:
        dockerfile: dp/cloud/docker/python/configuration_controller/Dockerfile
    - image: radio-controller
      context: ..
      docker:
        dockerfile: dp/cloud/docker/python/radio_controller/Dockerfile
    - image: db-service
      context: ..
      docker:
        dockerfile: dp/cloud/docker/python/db_service/Dockerfile
    - image: fake_sas
      context: tools/fake_sas
      docker:
        dockerfile: Dockerfile
deploy:
  kubectl:
    manifests:
      - "./tools/deployment/vendor/fake_sas.yml"
  helm:
    releases:
      - name: domain-proxy
        chartPath: ./cloud/helm/dp/charts/domain-proxy
        valuesFiles:
          - ./cloud/helm/dp/charts/domain-proxy/examples/minikube_values.yaml
        namespace: default
        version: "0.1.0"
        #wait: true
        artifactOverrides:
          active_mode_controller:
            image: active-mode-controller
          configuration_controller:
            image: configuration-controller
          protocol_controller:
            image: protocol-controller
          radio_controller:
            image: radio-controller
          db_service:
            image: db-service
        imageStrategy:
          helm: {}
profiles:
  - name: integration-tests
    patches:
      - op: add
        path: /build/artifacts/-
        value:
          image: test_runner_image
          context: ..
          docker:
            dockerfile: dp/cloud/docker/python/test_runner/Dockerfile
      #- op: add
        #path: /build/artifacts/-
        #value:
          #image: fake_sas
          #context: tools/fake_sas
          #docker:
            #dockerfile: tools/fake_sas/Dockerfile
      - op: add
        path: /deploy/helm/releases/0/setValueTemplates
        value:
          configuration_controller:
            extraEnv:
              APP_CONFIG: "TestConfig"
              #SQLALCHEMY_DATABASE_URI: "{{ .MYVAR }}"
          radio_controller:
            extraEnv:
              APP_CONFIG: "TestConfig"
              #SQLALCHEMY_DATABASE_URI: "{{ .MYVAR }}"
          db_service:
            extraEnv:
              APP_CONFIG: "TestConfig"
              #SQLALCHEMY_DATABASE_URI: "{{ .MYVAR }}"

      - op: add
        path: /deploy/kubectl
        value:
          flags:
            apply:
              - "--force=true"
          manifests:
           - "./tools/deployment/vendor/fake_sas.yml"
           - "./tools/deployment/tests/test_runner_*.yml"
    activation:
      - env: CI=true

  - name: nginx-ingress
    patches:
      - op: replace
        path: /deploy/helm/releases/0/valuesFiles/0
        value: ./charts/domain-proxy/examples/minikube_values_nginx.yaml
